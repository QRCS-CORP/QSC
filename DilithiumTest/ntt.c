#include "ntt.h"
#include "params.h"
#include "poly.h"
#include "reduce.h"

/* Roots of unity in order needed by forward ntt */
static const uint32_t zetas[DILITHIUM_N] = 
{ 
	0x00000000UL, 0x000064F7UL, 0x00581103UL, 0x0077F504UL, 0x00039E44UL, 0x00740119UL, 0x00728129UL, 0x00071E24UL,
	0x001BDE2BUL, 0x0023E92BUL, 0x007A64AEUL, 0x005FF480UL, 0x002F9A75UL, 0x0053DB0AUL, 0x002F7A49UL, 0x0028E527UL,
	0x00299658UL, 0x000FA070UL, 0x006F65A5UL, 0x0036B788UL, 0x00777D91UL, 0x006ECAA1UL, 0x0027F968UL, 0x005FB37CUL,
	0x005F8DD7UL, 0x0044FAE8UL, 0x006A84F8UL, 0x004DDC99UL, 0x001AD035UL, 0x007F9423UL, 0x003D3201UL, 0x000445C5UL,
	0x00294A67UL, 0x00017620UL, 0x002EF4CDUL, 0x0035DEC5UL, 0x00668504UL, 0x0049102DUL, 0x005927D5UL, 0x003BBEAFUL,
	0x0044F586UL, 0x00516E7DUL, 0x00368A96UL, 0x00541E42UL, 0x00360400UL, 0x007B4A4EUL, 0x0023D69CUL, 0x0077A55EUL,
	0x0065F23EUL, 0x0066CAD7UL, 0x00357E1EUL, 0x00458F5AUL, 0x0035843FUL, 0x005F3618UL, 0x0067745DUL, 0x0038738CUL,
	0x000C63A8UL, 0x00081B9AUL, 0x000E8F76UL, 0x003B3853UL, 0x003B8534UL, 0x0058DC31UL, 0x001F9D54UL, 0x00552F2EUL,
	0x0043E6E6UL, 0x00688C82UL, 0x0047C1D0UL, 0x0051781AUL, 0x0069B65EUL, 0x003509EEUL, 0x002135C7UL, 0x0067AFBCUL,
	0x006CAF76UL, 0x001D9772UL, 0x00419073UL, 0x00709CF7UL, 0x004F3281UL, 0x004FB2AFUL, 0x004870E1UL, 0x0001EFCAUL,
	0x003410F2UL, 0x0070DE86UL, 0x0020C638UL, 0x00296E9FUL, 0x005297A4UL, 0x0047844CUL, 0x00799A6EUL, 0x005A140AUL,
	0x0075A283UL, 0x006D2114UL, 0x007F863CUL, 0x006BE9F8UL, 0x007A0BDEUL, 0x001495D4UL, 0x001C4563UL, 0x006A0C63UL,
	0x004CDBEAUL, 0x00040AF0UL, 0x0007C417UL, 0x002F4588UL, 0x0000AD00UL, 0x006F16BFUL, 0x000DCD44UL, 0x003C675AUL,
	0x00470BCBUL, 0x007FBE7FUL, 0x00193948UL, 0x004E49C1UL, 0x0024756CUL, 0x007CA7E0UL, 0x000B98A1UL, 0x006BC809UL,
	0x0002E46CUL, 0x0049A809UL, 0x003036C2UL, 0x00639FF7UL, 0x005B1C94UL, 0x007D2AE1UL, 0x00141305UL, 0x00147792UL,
	0x00139E25UL, 0x0067B0E1UL, 0x00737945UL, 0x0069E803UL, 0x0051CEA3UL, 0x0044A79DUL, 0x00488058UL, 0x003A97D9UL,
	0x001FEA93UL, 0x0033FF5AUL, 0x002358D4UL, 0x003A41F8UL, 0x004CDF73UL, 0x00223DFBUL, 0x005A8BA0UL, 0x00498423UL,
	0x000412F5UL, 0x00252587UL, 0x006D04F1UL, 0x00359B5DUL, 0x004A28A1UL, 0x004682FDUL, 0x006D9B57UL, 0x004F25DFUL,
	0x000DBE5EUL, 0x001C5E1AUL, 0x000DE0E6UL, 0x000C7F5AUL, 0x00078F83UL, 0x0067428BUL, 0x007F3705UL, 0x0077E6FDUL,
	0x0075E022UL, 0x00503AF7UL, 0x001F0084UL, 0x0030EF86UL, 0x0049997EUL, 0x0077DCD7UL, 0x00742593UL, 0x004901C3UL,
	0x00053919UL, 0x0004610CUL, 0x005AAD42UL, 0x003EB01BUL, 0x003472E7UL, 0x004CE03CUL, 0x001A7CC7UL, 0x00031924UL,
	0x002B5EE5UL, 0x00291199UL, 0x00585A3BUL, 0x00134D71UL, 0x003DE11CUL, 0x00130984UL, 0x0025F051UL, 0x00185A46UL,
	0x00466519UL, 0x001314BEUL, 0x00283891UL, 0x0049BB91UL, 0x0052308AUL, 0x001C853FUL, 0x001D0B4BUL, 0x006FD6A7UL,
	0x006B88BFUL, 0x0012E11BUL, 0x004D3E3FUL, 0x006A0D30UL, 0x0078FDE5UL, 0x001406C7UL, 0x00327283UL, 0x0061ED6FUL,
	0x006C5954UL, 0x001D4099UL, 0x00590579UL, 0x006AE5AEUL, 0x0016E405UL, 0x000BDBE7UL, 0x00221DE8UL, 0x0033F8CFUL,
	0x00779935UL, 0x0054AA0DUL, 0x00665FF9UL, 0x0063B158UL, 0x0058711CUL, 0x00470C13UL, 0x000910D8UL, 0x00463E20UL,
	0x00612659UL, 0x00251D8BUL, 0x002573B7UL, 0x007D5C90UL, 0x001DDD98UL, 0x00336898UL, 0x0002D4BBUL, 0x006D73A8UL,
	0x004F4CBFUL, 0x00027C1CUL, 0x0018AA08UL, 0x002DFD71UL, 0x000C5CA5UL, 0x0019379AUL, 0x00478168UL, 0x00646C3EUL,
	0x0051813DUL, 0x0035C539UL, 0x003B0115UL, 0x00041DC0UL, 0x0021C4F7UL, 0x0070FBF5UL, 0x001A35E7UL, 0x0007340EUL,
	0x00795D46UL, 0x001A4CD0UL, 0x00645CAFUL, 0x001D2668UL, 0x00666E99UL, 0x006F0634UL, 0x007BE5DBUL, 0x00455FDCUL,
	0x00530765UL, 0x005DC1B0UL, 0x007973DEUL, 0x005CFD0AUL, 0x0002CC93UL, 0x0070F806UL, 0x00189C2AUL, 0x0049C5AAUL,
	0x00776A51UL, 0x003BCF2CUL, 0x007F234FUL, 0x006B16E0UL, 0x003C15CAUL, 0x00155E68UL, 0x0072F6B7UL, 0x001E29CEUL
};

/* Roots of unity in order needed by inverse ntt */
static const uint32_t zetas_inv[DILITHIUM_N] = 
{ 
	0x0061B633UL, 0x000CE94AUL, 0x006A8199UL, 0x0043CA37UL, 0x0014C921UL, 0x0000BCB2UL, 0x004410D5UL, 0x000875B0UL,
	0x00361A57UL, 0x006743D7UL, 0x000EE7FBUL, 0x007D136EUL, 0x0022E2F7UL, 0x00066C23UL, 0x00221E51UL, 0x002CD89CUL,
	0x003A8025UL, 0x0003FA26UL, 0x0010D9CDUL, 0x00197168UL, 0x0062B999UL, 0x001B8352UL, 0x00659331UL, 0x000682BBUL,
	0x0078ABF3UL, 0x0065AA1AUL, 0x000EE40CUL, 0x005E1B0AUL, 0x007BC241UL, 0x0044DEECUL, 0x004A1AC8UL, 0x002E5EC4UL,
	0x001B73C3UL, 0x00385E99UL, 0x0066A867UL, 0x0073835CUL, 0x0051E290UL, 0x006735F9UL, 0x007D63E5UL, 0x00309342UL,
	0x00126C59UL, 0x007D0B46UL, 0x004C7769UL, 0x00620269UL, 0x00028371UL, 0x005A6C4AUL, 0x005AC276UL, 0x001EB9A8UL,
	0x0039A1E1UL, 0x0076CF29UL, 0x0038D3EEUL, 0x00276EE5UL, 0x001C2EA9UL, 0x00198008UL, 0x002B35F4UL, 0x000846CCUL,
	0x004BE732UL, 0x005DC219UL, 0x0074041AUL, 0x0068FBFCUL, 0x0014FA53UL, 0x0026DA88UL, 0x00629F68UL, 0x001386ADUL,
	0x001DF292UL, 0x004D6D7EUL, 0x006BD93AUL, 0x0006E21CUL, 0x0015D2D1UL, 0x0032A1C2UL, 0x006CFEE6UL, 0x00145742UL,
	0x0010095AUL, 0x0062D4B6UL, 0x00635AC2UL, 0x002DAF77UL, 0x00362470UL, 0x0057A770UL, 0x006CCB43UL, 0x00397AE8UL,
	0x006785BBUL, 0x0059EFB0UL, 0x006CD67DUL, 0x0041FEE5UL, 0x006C9290UL, 0x002785C6UL, 0x0056CE68UL, 0x0054811CUL,
	0x007CC6DDUL, 0x0065633AUL, 0x0032FFC5UL, 0x004B6D1AUL, 0x00412FE6UL, 0x002532BFUL, 0x007B7EF5UL, 0x007AA6E8UL,
	0x0036DE3EUL, 0x000BBA6EUL, 0x0008032AUL, 0x00364683UL, 0x004EF07BUL, 0x0060DF7DUL, 0x002FA50AUL, 0x0009FFDFUL,
	0x0007F904UL, 0x0000A8FCUL, 0x00189D76UL, 0x0078507EUL, 0x007360A7UL, 0x0071FF1BUL, 0x006381E7UL, 0x007221A3UL,
	0x0030BA22UL, 0x001244AAUL, 0x00395D04UL, 0x0035B760UL, 0x004A44A4UL, 0x0012DB10UL, 0x005ABA7AUL, 0x007BCD0CUL,
	0x00365BDEUL, 0x00255461UL, 0x005DA206UL, 0x0033008EUL, 0x00459E09UL, 0x005C872DUL, 0x004BE0A7UL, 0x005FF56EUL,
	0x00454828UL, 0x00375FA9UL, 0x003B3864UL, 0x002E115EUL, 0x0015F7FEUL, 0x000C66BCUL, 0x00182F20UL, 0x006C41DCUL,
	0x006B686FUL, 0x006BCCFCUL, 0x0002B520UL, 0x0024C36DUL, 0x001C400AUL, 0x004FA93FUL, 0x003637F8UL, 0x007CFB95UL,
	0x001417F8UL, 0x00744760UL, 0x00033821UL, 0x005B6A95UL, 0x00319640UL, 0x0066A6B9UL, 0x00002182UL, 0x0038D436UL,
	0x004378A7UL, 0x007212BDUL, 0x0010C942UL, 0x007F3301UL, 0x00509A79UL, 0x00781BEAUL, 0x007BD511UL, 0x00330417UL,
	0x0015D39EUL, 0x00639A9EUL, 0x006B4A2DUL, 0x0005D423UL, 0x0013F609UL, 0x000059C5UL, 0x0012BEEDUL, 0x000A3D7EUL,
	0x0025CBF7UL, 0x00064593UL, 0x00385BB5UL, 0x002D485DUL, 0x00567162UL, 0x005F19C9UL, 0x000F017BUL, 0x004BCF0FUL,
	0x007DF037UL, 0x00376F20UL, 0x00302D52UL, 0x0030AD80UL, 0x000F430AUL, 0x003E4F8EUL, 0x0062488FUL, 0x0013308BUL,
	0x00183045UL, 0x005EAA3AUL, 0x004AD613UL, 0x001629A3UL, 0x002E67E7UL, 0x00381E31UL, 0x0017537FUL, 0x003BF91BUL,
	0x002AB0D3UL, 0x006042ADUL, 0x002703D0UL, 0x00445ACDUL, 0x0044A7AEUL, 0x0071508BUL, 0x0077C467UL, 0x00737C59UL,
	0x00476C75UL, 0x00186BA4UL, 0x0020A9E9UL, 0x004A5BC2UL, 0x003A50A7UL, 0x004A61E3UL, 0x0019152AUL, 0x0019EDC3UL,
	0x00083AA3UL, 0x005C0965UL, 0x000495B3UL, 0x0049DC01UL, 0x002BC1BFUL, 0x0049556BUL, 0x002E7184UL, 0x003AEA7BUL,
	0x00442152UL, 0x0026B82CUL, 0x0036CFD4UL, 0x00195AFDUL, 0x004A013CUL, 0x0050EB34UL, 0x007E69E1UL, 0x0056959AUL,
	0x007B9A3CUL, 0x0042AE00UL, 0x00004BDEUL, 0x00650FCCUL, 0x00320368UL, 0x00155B09UL, 0x003AE519UL, 0x0020522AUL,
	0x00202C85UL, 0x0057E699UL, 0x00111560UL, 0x00086270UL, 0x00492879UL, 0x00107A5CUL, 0x00703F91UL, 0x005649A9UL,
	0x0056FADAUL, 0x005065B8UL, 0x002C04F7UL, 0x0050458CUL, 0x001FEB81UL, 0x00057B53UL, 0x005BF6D6UL, 0x006401D6UL,
	0x0078C1DDUL, 0x000D5ED8UL, 0x000BDEE8UL, 0x007C41BDUL, 0x0007EAFDUL, 0x0027CEFEUL, 0x007F7B0AUL, 0x00000000UL
};

void ntt(uint32_t p[DILITHIUM_N])
{
	size_t j;
	size_t k;
	size_t len;
	size_t start;
	uint32_t t;
	uint32_t zeta;

	k = 1;

	for (len = 128; len > 0; len >>= 1) 
	{
		for (start = 0; start < DILITHIUM_N; start = j + len) 
		{
			zeta = zetas[k];
			++k;

			for (j = start; j < start + len; ++j) 
			{
				t = montgomery_reduce((uint64_t)zeta * p[j + len]);
				p[j + len] = p[j] + (2 * DILITHIUM_Q) - t;
				p[j] = p[j] + t;
			}
		}
	}
}

void invntt_frominvmont(uint32_t p[DILITHIUM_N]) 
{
	const uint32_t F = (((uint64_t)DILITHIUM_MONT * DILITHIUM_MONT % DILITHIUM_Q) * (DILITHIUM_Q - 1) % DILITHIUM_Q) * ((DILITHIUM_Q - 1) >> 8) % DILITHIUM_Q;
	size_t j;
	size_t k;
	size_t len;
	size_t start;
	uint32_t t;
	uint32_t zeta;

	k = 0;

	for (len = 1; len < DILITHIUM_N; len <<= 1) 
	{
		for (start = 0; start < DILITHIUM_N; start = j + len) 
		{
			zeta = zetas_inv[k];
			++k;

			for (j = start; j < start + len; ++j) 
			{
				t = p[j];
				p[j] = t + p[j + len];
				p[j + len] = t + (256 * DILITHIUM_Q) - p[j + len];
				p[j + len] = montgomery_reduce((uint64_t)zeta * p[j + len]);
			}
		}
	}

	for (j = 0; j < DILITHIUM_N; ++j) 
	{
		p[j] = montgomery_reduce((uint64_t)F * p[j]);
	}
}
