\doxysection{falconbase\+\_\+avx2.\+h}
\hypertarget{falconbase__avx2_8h_source}{}\label{falconbase__avx2_8h_source}\index{C:/Users/stepp/Documents/Visual Studio 2022/Projects/C/QSC/QSC/falconbase\_avx2.h@{C:/Users/stepp/Documents/Visual Studio 2022/Projects/C/QSC/QSC/falconbase\_avx2.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/*\ 2025\ Quantum\ Resistant\ Cryptographic\ Solutions\ Corporation}}
\DoxyCodeLine{00002\ \textcolor{comment}{\ *\ All\ Rights\ Reserved.}}
\DoxyCodeLine{00003\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00004\ \textcolor{comment}{\ *\ NOTICE:\ This\ software\ and\ all\ accompanying\ materials\ are\ the\ exclusive\ }}
\DoxyCodeLine{00005\ \textcolor{comment}{\ *\ property\ of\ Quantum\ Resistant\ Cryptographic\ Solutions\ Corporation\ (QRCS).}}
\DoxyCodeLine{00006\ \textcolor{comment}{\ *\ The\ intellectual\ and\ technical\ concepts\ contained\ within\ this\ implementation\ }}
\DoxyCodeLine{00007\ \textcolor{comment}{\ *\ are\ proprietary\ to\ QRCS\ and\ its\ authorized\ licensors\ and\ are\ protected\ under\ }}
\DoxyCodeLine{00008\ \textcolor{comment}{\ *\ applicable\ U.S.\ and\ international\ copyright,\ patent,\ and\ trade\ secret\ laws.}}
\DoxyCodeLine{00009\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00010\ \textcolor{comment}{\ *\ CRYPTOGRAPHIC\ STANDARDS:}}
\DoxyCodeLine{00011\ \textcolor{comment}{\ *\ -\/\ This\ software\ includes\ implementations\ of\ cryptographic\ algorithms\ such\ as\ }}
\DoxyCodeLine{00012\ \textcolor{comment}{\ *\ \ \ SHA3,\ AES,\ and\ others.\ These\ algorithms\ are\ public\ domain\ or\ standardized\ }}
\DoxyCodeLine{00013\ \textcolor{comment}{\ *\ \ \ by\ organizations\ such\ as\ NIST\ and\ are\ NOT\ the\ property\ of\ QRCS.}}
\DoxyCodeLine{00014\ \textcolor{comment}{\ *\ -\/\ However,\ all\ source\ code,\ optimizations,\ and\ implementations\ in\ this\ library\ }}
\DoxyCodeLine{00015\ \textcolor{comment}{\ *\ \ \ are\ original\ works\ of\ QRCS\ and\ are\ protected\ under\ this\ license.}}
\DoxyCodeLine{00016\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00017\ \textcolor{comment}{\ *\ RESTRICTIONS:}}
\DoxyCodeLine{00018\ \textcolor{comment}{\ *\ -\/\ Redistribution,\ modification,\ or\ unauthorized\ distribution\ of\ this\ software,\ }}
\DoxyCodeLine{00019\ \textcolor{comment}{\ *\ \ \ in\ whole\ or\ in\ part,\ is\ strictly\ prohibited.}}
\DoxyCodeLine{00020\ \textcolor{comment}{\ *\ -\/\ This\ software\ is\ provided\ for\ non-\/commercial,\ educational,\ and\ research\ }}
\DoxyCodeLine{00021\ \textcolor{comment}{\ *\ \ \ purposes\ only.\ Commercial\ use\ in\ any\ form\ is\ expressly\ forbidden.}}
\DoxyCodeLine{00022\ \textcolor{comment}{\ *\ -\/\ Licensing\ and\ authorized\ distribution\ are\ solely\ at\ the\ discretion\ of\ QRCS.}}
\DoxyCodeLine{00023\ \textcolor{comment}{\ *\ -\/\ Any\ use\ of\ this\ software\ implies\ acceptance\ of\ these\ restrictions.}}
\DoxyCodeLine{00024\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00025\ \textcolor{comment}{\ *\ DISCLAIMER:}}
\DoxyCodeLine{00026\ \textcolor{comment}{\ *\ This\ software\ is\ provided\ "{}as\ is,"{}\ without\ warranty\ of\ any\ kind,\ express\ or\ }}
\DoxyCodeLine{00027\ \textcolor{comment}{\ *\ implied,\ including\ but\ not\ limited\ to\ warranties\ of\ merchantability\ or\ fitness\ }}
\DoxyCodeLine{00028\ \textcolor{comment}{\ *\ for\ a\ particular\ purpose.\ QRCS\ disclaims\ all\ liability\ for\ any\ direct,\ indirect,\ }}
\DoxyCodeLine{00029\ \textcolor{comment}{\ *\ incidental,\ or\ consequential\ damages\ resulting\ from\ the\ use\ or\ misuse\ of\ this\ software.}}
\DoxyCodeLine{00030\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00031\ \textcolor{comment}{\ *\ FULL\ LICENSE:}}
\DoxyCodeLine{00032\ \textcolor{comment}{\ *\ This\ software\ is\ subject\ to\ the\ **Quantum\ Resistant\ Cryptographic\ Solutions\ }}
\DoxyCodeLine{00033\ \textcolor{comment}{\ *\ Proprietary\ License\ (QRCS-\/PL)**.\ The\ complete\ license\ terms\ are\ included\ }}
\DoxyCodeLine{00034\ \textcolor{comment}{\ *\ in\ the\ LICENSE.txt\ file\ distributed\ with\ this\ software.}}
\DoxyCodeLine{00035\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00036\ \textcolor{comment}{\ *\ Written\ by:\ John\ G.\ Underhill}}
\DoxyCodeLine{00037\ \textcolor{comment}{\ *\ Contact:\ john.underhill@protonmail.com}}
\DoxyCodeLine{00038\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \textcolor{preprocessor}{\#ifndef\ QSC\_FALCONBASE\_AVX2\_H}}
\DoxyCodeLine{00042\ \textcolor{preprocessor}{\#define\ QSC\_FALCONBASE\_AVX2\_H}}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \textcolor{comment}{/*\ \(\backslash\)cond\ DOXYGEN\_IGNORE\ */}}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00046\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{common_8h}{common.h}}"{}}}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \textcolor{preprocessor}{\#if\ defined(QSC\_SYSTEM\_HAS\_AVX2)}}
\DoxyCodeLine{00049\ }
\DoxyCodeLine{00050\ \textcolor{preprocessor}{\#include\ "{}intrinsics.h"{}}}
\DoxyCodeLine{00051\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{sha3_8h}{sha3.h}}"{}}}
\DoxyCodeLine{00052\ \textcolor{preprocessor}{\#include\ <math.h>}}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00054\ \textcolor{comment}{/*\ api.h\ */}}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \textcolor{preprocessor}{\#if\ defined(QSC\_FALCON\_S3SHAKE256F512)}}
\DoxyCodeLine{00057\ \textcolor{preprocessor}{\#\ \ \ define\ CRYPTO\_SECRETKEYBYTES\ 1281}}
\DoxyCodeLine{00058\ \textcolor{preprocessor}{\#\ \ \ define\ CRYPTO\_PUBLICKEYBYTES\ 897}}
\DoxyCodeLine{00059\ \textcolor{preprocessor}{\#\ \ \ define\ CRYPTO\_BYTES\ 690}}
\DoxyCodeLine{00060\ \textcolor{preprocessor}{\#\ \ \ define\ CRYPTO\_ALGNAME\ "{}Falcon-\/512"{}}}
\DoxyCodeLine{00061\ \textcolor{preprocessor}{\#elif\ defined(QSC\_FALCON\_S5SHAKE256F1024)}}
\DoxyCodeLine{00062\ \textcolor{preprocessor}{\#\ \ \ define\ CRYPTO\_SECRETKEYBYTES\ 2305}}
\DoxyCodeLine{00063\ \textcolor{preprocessor}{\#\ \ \ define\ CRYPTO\_PUBLICKEYBYTES\ 1793}}
\DoxyCodeLine{00064\ \textcolor{preprocessor}{\#\ \ \ define\ CRYPTO\_BYTES\ 1330}}
\DoxyCodeLine{00065\ \textcolor{preprocessor}{\#\ \ \ define\ CRYPTO\_ALGNAME\ "{}Falcon-\/1024"{}}}
\DoxyCodeLine{00066\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \textcolor{comment}{/*\ falcon\_fpr.h\ */}}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \textcolor{preprocessor}{\#define\ FALCON\_FPR\_GM\_TAB\_SIZE\ 2048}}
\DoxyCodeLine{00071\ \textcolor{preprocessor}{\#define\ FALCON\_FPR\_INV\_SIGMA\_SIZE\ 11}}
\DoxyCodeLine{00072\ \textcolor{preprocessor}{\#define\ FALCON\_FPR\_GM\_P2\_SIZE\ 11}}
\DoxyCodeLine{00073\ \textcolor{preprocessor}{\#define\ FALCON\_Q\ 12289}}
\DoxyCodeLine{00074\ \textcolor{preprocessor}{\#define\ FALCON\_Q0I\ 12287}}
\DoxyCodeLine{00075\ \textcolor{preprocessor}{\#define\ FALCON\_R\ 4091}}
\DoxyCodeLine{00076\ \textcolor{preprocessor}{\#define\ FALCON\_R2\ 10952}}
\DoxyCodeLine{00077\ \textcolor{preprocessor}{\#define\ FALCON\_GMB\_SIZE\ 1024}}
\DoxyCodeLine{00078\ \textcolor{preprocessor}{\#define\ FALCON\_KEYGEN\_TEMP\_1\ 136}}
\DoxyCodeLine{00079\ \textcolor{preprocessor}{\#define\ FALCON\_KEYGEN\_TEMP\_2\ 272}}
\DoxyCodeLine{00080\ \textcolor{preprocessor}{\#define\ FALCON\_KEYGEN\_TEMP\_3\ 224}}
\DoxyCodeLine{00081\ \textcolor{preprocessor}{\#define\ FALCON\_KEYGEN\_TEMP\_4\ 448}}
\DoxyCodeLine{00082\ \textcolor{preprocessor}{\#define\ FALCON\_KEYGEN\_TEMP\_5\ 896}}
\DoxyCodeLine{00083\ \textcolor{preprocessor}{\#define\ FALCON\_KEYGEN\_TEMP\_6\ 1792}}
\DoxyCodeLine{00084\ \textcolor{preprocessor}{\#define\ FALCON\_KEYGEN\_TEMP\_7\ 3584}}
\DoxyCodeLine{00085\ \textcolor{preprocessor}{\#define\ FALCON\_KEYGEN\_TEMP\_8\ 7168}}
\DoxyCodeLine{00086\ \textcolor{preprocessor}{\#define\ FALCON\_KEYGEN\_TEMP\_9\ 14336}}
\DoxyCodeLine{00087\ \textcolor{preprocessor}{\#define\ FALCON\_KEYGEN\_TEMP\_10\ 28672}}
\DoxyCodeLine{00088\ \textcolor{preprocessor}{\#define\ FALCON\_SMALL\_PRIME\_SIZE\ 522}}
\DoxyCodeLine{00089\ \textcolor{preprocessor}{\#define\ FALCON\_GAUS\_1024\_12289\_SIZE\ 27}}
\DoxyCodeLine{00090\ \textcolor{preprocessor}{\#define\ FALCON\_MAX\_BL\_SMALL\_SIZE\ 11}}
\DoxyCodeLine{00091\ \textcolor{preprocessor}{\#define\ FALCON\_MAX\_BL\_LARGE\_SIZE\ 10}}
\DoxyCodeLine{00092\ \textcolor{preprocessor}{\#define\ FALCON\_DEPTH\_INT\_FG\ 4}}
\DoxyCodeLine{00093\ \textcolor{preprocessor}{\#define\ FALCON\_NONCE\_SIZE\ 40}}
\DoxyCodeLine{00094\ \textcolor{preprocessor}{\#define\ FALCON\_L2BOUND\_SIZE\ 11}}
\DoxyCodeLine{00095\ \textcolor{preprocessor}{\#define\ FALCON\_MAXBITS\_SIZE\ 11}}
\DoxyCodeLine{00096\ \textcolor{preprocessor}{\#define\ FALCON\_REV10\_SIZE\ 1024}}
\DoxyCodeLine{00097\ }
\DoxyCodeLine{00098\ \textcolor{preprocessor}{\#if\ defined(\_\_GNUC\_\_)}}
\DoxyCodeLine{00099\ \textcolor{preprocessor}{\#\ \ \ if\ defined(FALCON\_FMA)}}
\DoxyCodeLine{00100\ \textcolor{preprocessor}{\#\ \ \ \ \ \ \ define\ FALCON\_TARGET\_AVX2\ \_\_attribute\_\_((target("{}avx2,fma"{})))}}
\DoxyCodeLine{00101\ \textcolor{preprocessor}{\#\ \ \ else}}
\DoxyCodeLine{00102\ \textcolor{preprocessor}{\#\ \ \ \ \ \ \ define\ FALCON\_TARGET\_AVX2\ \_\_attribute\_\_((target("{}avx2"{})))}}
\DoxyCodeLine{00103\ \textcolor{preprocessor}{\#\ \ \ endif}}
\DoxyCodeLine{00104\ \textcolor{preprocessor}{\#elif\ defined(\_MSC\_VER)}}
\DoxyCodeLine{00105\ \textcolor{preprocessor}{\#\ \ \ define\ FALCON\_TARGET\_AVX2}}
\DoxyCodeLine{00106\ \textcolor{preprocessor}{\#\ \ \ pragma\ warning(\ disable\ :\ 4752\ )}}
\DoxyCodeLine{00107\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00109\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ \_\_m256d\ falcon\_fmadd(\_\_m256d\ a,\ \_\_m256d\ b,\ \_\_m256d\ c)}
\DoxyCodeLine{00110\ \{}
\DoxyCodeLine{00111\ \textcolor{preprocessor}{\#if\ defined(FALCON\_FMA)}}
\DoxyCodeLine{00112\ \ \ \ \ \textcolor{keywordflow}{return}\ \_mm256\_fmadd\_pd(a,\ b,\ c);}
\DoxyCodeLine{00113\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00114\ \ \ \ \ \_\_m256d\ tmp;}
\DoxyCodeLine{00115\ \ \ \ \ tmp\ =\ \_mm256\_mul\_pd(a,\ b);}
\DoxyCodeLine{00116\ \ \ \ \ tmp\ =\ \_mm256\_add\_pd(tmp,\ c);}
\DoxyCodeLine{00117\ \ \ \ \ \textcolor{keywordflow}{return}\ tmp;}
\DoxyCodeLine{00118\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00119\ \}}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ \_\_m256d\ falcon\_fmsub(\_\_m256d\ a,\ \_\_m256d\ b,\ \_\_m256d\ c)}
\DoxyCodeLine{00122\ \{}
\DoxyCodeLine{00123\ \ \ \ \ \textcolor{comment}{/*\ Note\ artifact,\ unused\ function\ */}}
\DoxyCodeLine{00124\ \textcolor{preprocessor}{\#if\ defined(FALCON\_FMA)}}
\DoxyCodeLine{00125\ \ \ \ \ \textcolor{keywordflow}{return}\ \_mm256\_fmsub\_pd(a,\ b,\ c);}
\DoxyCodeLine{00126\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00127\ \ \ \ \ \_\_m256d\ tmp;}
\DoxyCodeLine{00128\ \ \ \ \ tmp\ =\ \_mm256\_mul\_pd(a,\ b);}
\DoxyCodeLine{00129\ \ \ \ \ \textcolor{keywordflow}{return}\ \_mm256\_sub\_pd(tmp,\ c);}
\DoxyCodeLine{00130\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00131\ \}}
\DoxyCodeLine{00132\ }
\DoxyCodeLine{00133\ \textcolor{comment}{//inline\ static\ uint32\_t\ falcon\_set\_fpu\_cw(uint32\_t\ x)}}
\DoxyCodeLine{00134\ \textcolor{comment}{//\{}}
\DoxyCodeLine{00135\ \textcolor{comment}{//\#if\ defined\ \_\_GNUC\_\_\ \&\&\ defined\ \_\_i386\_\_}}
\DoxyCodeLine{00136\ \textcolor{comment}{//\ \ uint32\_t\ short\ t;}}
\DoxyCodeLine{00137\ \textcolor{comment}{//\ \ uint32\_t\ old;}}
\DoxyCodeLine{00138\ \textcolor{comment}{//}}
\DoxyCodeLine{00139\ \textcolor{comment}{//\ \ \_\_asm\_\_\ \_\_volatile\_\_("{}fstcw\ \%0"{}\ :\ "{}=m"{}\ (t)\ :\ :\ );}}
\DoxyCodeLine{00140\ \textcolor{comment}{//\ \ old\ =\ (t\ \&\ 0x0300u)\ >>\ 8;}}
\DoxyCodeLine{00141\ \textcolor{comment}{//\ \ t\ =\ (uint32\_t\ short)((t\ \&\ \string~0x0300u)\ |\ (x\ <<\ 8));}}
\DoxyCodeLine{00142\ \textcolor{comment}{//\ \ \_\_asm\_\_\ \_\_volatile\_\_("{}fldcw\ \%0"{}\ :\ :\ "{}m"{}\ (t)\ :\ );}}
\DoxyCodeLine{00143\ \textcolor{comment}{//\ \ return\ old;}}
\DoxyCodeLine{00144\ \textcolor{comment}{//\#elif\ defined\ \_M\_IX86}}
\DoxyCodeLine{00145\ \textcolor{comment}{//\ \ uint32\_t\ short\ t;}}
\DoxyCodeLine{00146\ \textcolor{comment}{//\ \ uint32\_t\ old;}}
\DoxyCodeLine{00147\ \textcolor{comment}{//}}
\DoxyCodeLine{00148\ \textcolor{comment}{//\ \ \_\_asm\ \{\ fstcw\ t\ \}}}
\DoxyCodeLine{00149\ \textcolor{comment}{//\ \ old\ =\ (t\ \&\ 0x0300u)\ >>\ 8;}}
\DoxyCodeLine{00150\ \textcolor{comment}{//\ \ t\ =\ (uint32\_t\ short)((t\ \&\ \string~0x0300u)\ |\ (x\ <<\ 8));}}
\DoxyCodeLine{00151\ \textcolor{comment}{//\ \ \_\_asm\ \{\ fldcw\ t\ \}}}
\DoxyCodeLine{00152\ \textcolor{comment}{//\ \ return\ old;}}
\DoxyCodeLine{00153\ \textcolor{comment}{//\#else}}
\DoxyCodeLine{00154\ \textcolor{comment}{//\ \ return\ x;}}
\DoxyCodeLine{00155\ \textcolor{comment}{//\#endif}}
\DoxyCodeLine{00156\ \textcolor{comment}{//\}}}
\DoxyCodeLine{00157\ }
\DoxyCodeLine{00158\ \textcolor{comment}{/*}}
\DoxyCodeLine{00159\ \textcolor{comment}{\ *\ For\ optimal\ reproducibility\ of\ values,\ we\ need\ to\ disable\ contraction}}
\DoxyCodeLine{00160\ \textcolor{comment}{\ *\ of\ floating-\/point\ expressions;\ otherwise,\ on\ some\ architectures\ (e.g.}}
\DoxyCodeLine{00161\ \textcolor{comment}{\ *\ PowerPC),\ the\ compiler\ may\ generate\ fused-\/multiply-\/add\ opcodes\ that}}
\DoxyCodeLine{00162\ \textcolor{comment}{\ *\ may\ round\ differently\ than\ two\ successive\ separate\ opcodes.\ C99\ defines}}
\DoxyCodeLine{00163\ \textcolor{comment}{\ *\ a\ standard\ pragma\ for\ that,\ but\ GCC-\/6.2.2\ appears\ to\ ignore\ it,}}
\DoxyCodeLine{00164\ \textcolor{comment}{\ *\ hence\ the\ GCC-\/specific\ pragma\ (that\ Clang\ does\ not\ support).}}
\DoxyCodeLine{00165\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00166\ \textcolor{preprocessor}{\#if\ defined\ \_\_clang\_\_}}
\DoxyCodeLine{00167\ \textcolor{preprocessor}{\#\ \ \ pragma\ STDC\ FP\_CONTRACT\ OFF}}
\DoxyCodeLine{00168\ \textcolor{preprocessor}{\#elif\ defined\ \_\_GNUC\_\_}}
\DoxyCodeLine{00169\ \textcolor{preprocessor}{\#\ \ \ pragma\ GCC\ optimize\ ("{}fp-\/contract=off"{})}}
\DoxyCodeLine{00170\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00171\ }
\DoxyCodeLine{00172\ \ \textcolor{comment}{/*\ prng.c\ */}}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00174\ \textcolor{keyword}{typedef}\ \textcolor{keyword}{struct}}
\DoxyCodeLine{00175\ \{}
\DoxyCodeLine{00176\ \ \ \ \ QSC\_ALIGN(8)\ uint8\_t\ buf[512];}
\DoxyCodeLine{00177\ \ \ \ \ QSC\_ALIGN(8)\ uint8\_t\ state[256];}
\DoxyCodeLine{00178\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ ptr;}
\DoxyCodeLine{00179\ \ \ \ \ int32\_t\ type;}
\DoxyCodeLine{00180\ \}\ falcon\_prng\_state;}
\DoxyCodeLine{00181\ }
\DoxyCodeLine{00182\ inline\ static\ \textcolor{keywordtype}{void}\ falcon\_chacha\_round(uint32\_t\ state[16],\ \textcolor{keywordtype}{size\_t}\ a,\ \textcolor{keywordtype}{size\_t}\ b,\ \textcolor{keywordtype}{size\_t}\ c,\ \textcolor{keywordtype}{size\_t}\ d)}
\DoxyCodeLine{00183\ \{}
\DoxyCodeLine{00184\ \ \ \ \ state[a]\ +=\ state[b];}
\DoxyCodeLine{00185\ \ \ \ \ state[d]\ \string^=\ state[a];}
\DoxyCodeLine{00186\ \ \ \ \ state[d]\ =\ (state[d]\ <<\ 16)\ |\ (state[d]\ >>\ 16);}
\DoxyCodeLine{00187\ \ \ \ \ state[c]\ +=\ state[d];}
\DoxyCodeLine{00188\ \ \ \ \ state[b]\ \string^=\ state[c];}
\DoxyCodeLine{00189\ \ \ \ \ state[b]\ =\ (state[b]\ <<\ 12)\ |\ (state[b]\ >>\ 20);}
\DoxyCodeLine{00190\ \ \ \ \ state[a]\ +=\ state[b];}
\DoxyCodeLine{00191\ \ \ \ \ state[d]\ \string^=\ state[a];}
\DoxyCodeLine{00192\ \ \ \ \ state[d]\ =\ (state[d]\ <<\ 8)\ |\ (state[d]\ >>\ 24);}
\DoxyCodeLine{00193\ \ \ \ \ state[c]\ +=\ state[d];}
\DoxyCodeLine{00194\ \ \ \ \ state[b]\ \string^=\ state[c];}
\DoxyCodeLine{00195\ \ \ \ \ state[b]\ =\ (state[b]\ <<\ 7)\ |\ (state[b]\ >>\ 25);}
\DoxyCodeLine{00196\ \}}
\DoxyCodeLine{00197\ }
\DoxyCodeLine{00198\ \textcolor{comment}{/*}}
\DoxyCodeLine{00199\ \textcolor{comment}{\ *\ We\ wrap\ the\ native\ 'double'\ type\ into\ a\ structure\ so\ that\ the\ C\ compiler}}
\DoxyCodeLine{00200\ \textcolor{comment}{\ *\ complains\ if\ we\ inadvertently\ use\ raw\ arithmetic\ operators\ on\ the\ 'falcon\_fpr'}}
\DoxyCodeLine{00201\ \textcolor{comment}{\ *\ type\ instead\ of\ using\ the\ inline\ functions\ below.\ This\ should\ have\ no}}
\DoxyCodeLine{00202\ \textcolor{comment}{\ *\ extra\ runtime\ cost,\ since\ all\ the\ functions\ below\ are\ 'inline'.}}
\DoxyCodeLine{00203\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00204\ \textcolor{keyword}{typedef}\ \textcolor{keyword}{struct\ }\{\ \textcolor{keywordtype}{double}\ v;\ \}\ falcon\_fpr;}
\DoxyCodeLine{00205\ }
\DoxyCodeLine{00206\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_q\ =\ \{\ 12289.0\ \};}
\DoxyCodeLine{00207\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_inverse\_of\_q\ =\ \{\ 1.0\ /\ 12289.0\ \};}
\DoxyCodeLine{00208\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_inv\_2sqrsigma0\ =\ \{\ 0.150865048875372721532312163019\ \};}
\DoxyCodeLine{00209\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_log2\ =\ \{\ 0.69314718055994530941723212146\ \};}
\DoxyCodeLine{00210\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_inv\_log2\ =\ \{\ 1.4426950408889634073599246810\ \};}
\DoxyCodeLine{00211\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_bnorm\_max\ =\ \{\ 16822.4121\ \};}
\DoxyCodeLine{00212\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_zero\ =\ \{\ 0.0\ \};}
\DoxyCodeLine{00213\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_one\ =\ \{\ 1.0\ \};}
\DoxyCodeLine{00214\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_two\ =\ \{\ 2.0\ \};}
\DoxyCodeLine{00215\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_onehalf\ =\ \{\ 0.5\ \};}
\DoxyCodeLine{00216\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_invsqrt2\ =\ \{\ 0.707106781186547524400844362105\ \};}
\DoxyCodeLine{00217\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_invsqrt8\ =\ \{\ 0.353553390593273762200422181052\ \};}
\DoxyCodeLine{00218\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_ptwo31\ =\ \{\ 2147483648.0\ \};}
\DoxyCodeLine{00219\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_ptwo31m1\ =\ \{\ 2147483647.0\ \};}
\DoxyCodeLine{00220\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_mtwo31m1\ =\ \{\ -\/2147483647.0\ \};}
\DoxyCodeLine{00221\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_ptwo63m1\ =\ \{\ 9223372036854775807.0\ \};}
\DoxyCodeLine{00222\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_mtwo63m1\ =\ \{\ -\/9223372036854775807.0\ \};}
\DoxyCodeLine{00223\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_fpr\_ptwo63\ =\ \{\ 9223372036854775808.0\ \};}
\DoxyCodeLine{00224\ }
\DoxyCodeLine{00225\ \textcolor{keyword}{extern}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_avx2\_fpr\_inv\_sigma[FALCON\_FPR\_INV\_SIGMA\_SIZE];}
\DoxyCodeLine{00226\ }
\DoxyCodeLine{00227\ \textcolor{keyword}{extern}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_avx2\_fpr\_sigma\_min[FALCON\_FPR\_INV\_SIGMA\_SIZE];}
\DoxyCodeLine{00228\ }
\DoxyCodeLine{00229\ \textcolor{keyword}{extern}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_avx2\_fpr\_gm\_tab[FALCON\_FPR\_GM\_TAB\_SIZE];}
\DoxyCodeLine{00230\ }
\DoxyCodeLine{00231\ \textcolor{keyword}{extern}\ \textcolor{keyword}{const}\ falcon\_fpr\ falcon\_avx2\_fpr\_p2\_tab[FALCON\_FPR\_GM\_P2\_SIZE];}
\DoxyCodeLine{00232\ }
\DoxyCodeLine{00233\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ falcon\_fpr\ falcon\_FPR(\textcolor{keywordtype}{double}\ v)}
\DoxyCodeLine{00234\ \{}
\DoxyCodeLine{00235\ \ \ \ \ falcon\_fpr\ x\ =\ \{\ 0\ \};}
\DoxyCodeLine{00236\ }
\DoxyCodeLine{00237\ \ \ \ \ x.v\ =\ v;}
\DoxyCodeLine{00238\ }
\DoxyCodeLine{00239\ \ \ \ \ \textcolor{keywordflow}{return}\ x;}
\DoxyCodeLine{00240\ \}}
\DoxyCodeLine{00241\ }
\DoxyCodeLine{00242\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ falcon\_fpr\ falcon\_fpr\_of(int64\_t\ i)}
\DoxyCodeLine{00243\ \{}
\DoxyCodeLine{00244\ \ \ \ \ \textcolor{keywordflow}{return}\ falcon\_FPR((\textcolor{keywordtype}{double})i);}
\DoxyCodeLine{00245\ \}}
\DoxyCodeLine{00246\ }
\DoxyCodeLine{00247\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ int64\_t\ falcon\_fpr\_rint(falcon\_fpr\ x)}
\DoxyCodeLine{00248\ \{}
\DoxyCodeLine{00249\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00250\ \textcolor{comment}{\ \ \ \ \ *\ We\ do\ not\ want\ to\ use\ llrint()\ since\ it\ might\ be\ not}}
\DoxyCodeLine{00251\ \textcolor{comment}{\ \ \ \ \ *\ constant-\/time.}}
\DoxyCodeLine{00252\ \textcolor{comment}{\ \ \ \ \ *}}
\DoxyCodeLine{00253\ \textcolor{comment}{\ \ \ \ \ *\ Suppose\ that\ x\ >=\ 0.\ If\ x\ >=\ 2\string^52,\ then\ it\ is\ already\ an}}
\DoxyCodeLine{00254\ \textcolor{comment}{\ \ \ \ \ *\ integer.\ Otherwise,\ if\ x\ <\ 2\string^52,\ then\ computing\ x+2\string^52\ will}}
\DoxyCodeLine{00255\ \textcolor{comment}{\ \ \ \ \ *\ yield\ a\ value\ that\ will\ be\ rounded\ to\ the\ nearest\ integer}}
\DoxyCodeLine{00256\ \textcolor{comment}{\ \ \ \ \ *\ with\ exactly\ the\ right\ rules\ (round-\/to-\/nearest-\/even).}}
\DoxyCodeLine{00257\ \textcolor{comment}{\ \ \ \ \ *}}
\DoxyCodeLine{00258\ \textcolor{comment}{\ \ \ \ \ *\ In\ order\ to\ have\ constant-\/time\ processing,\ we\ must\ do\ the}}
\DoxyCodeLine{00259\ \textcolor{comment}{\ \ \ \ \ *\ computation\ for\ both\ x\ >=\ 0\ and\ x\ <\ 0\ cases,\ and\ use\ a}}
\DoxyCodeLine{00260\ \textcolor{comment}{\ \ \ \ \ *\ cast\ to\ an\ integer\ to\ access\ the\ sign\ and\ select\ the\ proper}}
\DoxyCodeLine{00261\ \textcolor{comment}{\ \ \ \ \ *\ value.\ Such\ casts\ also\ allow\ us\ to\ find\ out\ if\ |x|\ <\ 2\string^52.}}
\DoxyCodeLine{00262\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00263\ \ \ \ \ int64\_t\ sx,\ tx,\ rp,\ rn,\ m;}
\DoxyCodeLine{00264\ \ \ \ \ uint32\_t\ ub;}
\DoxyCodeLine{00265\ }
\DoxyCodeLine{00266\ \ \ \ \ sx\ =\ (int64\_t)(x.v\ -\/\ 1.0);}
\DoxyCodeLine{00267\ \ \ \ \ tx\ =\ (int64\_t)x.v;}
\DoxyCodeLine{00268\ \ \ \ \ rp\ =\ (int64\_t)(x.v\ +\ 4503599627370496.0)\ -\/\ 4503599627370496;}
\DoxyCodeLine{00269\ \ \ \ \ rn\ =\ (int64\_t)(x.v\ -\/\ 4503599627370496.0)\ +\ 4503599627370496;}
\DoxyCodeLine{00270\ }
\DoxyCodeLine{00271\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00272\ \textcolor{comment}{\ \ \ \ \ *\ If\ tx\ >=\ 2\string^52\ or\ tx\ <\ -\/2\string^52,\ then\ result\ is\ tx.}}
\DoxyCodeLine{00273\ \textcolor{comment}{\ \ \ \ \ *\ Otherwise,\ if\ sx\ >=\ 0,\ then\ result\ is\ rp.}}
\DoxyCodeLine{00274\ \textcolor{comment}{\ \ \ \ \ *\ Otherwise,\ result\ is\ rn.\ We\ use\ the\ fact\ that\ when\ x\ is}}
\DoxyCodeLine{00275\ \textcolor{comment}{\ \ \ \ \ *\ close\ to\ 0\ (|x|\ <=\ 0.25)\ then\ both\ rp\ and\ rn\ are\ correct;}}
\DoxyCodeLine{00276\ \textcolor{comment}{\ \ \ \ \ *\ and\ if\ x\ is\ not\ close\ to\ 0,\ then\ trunc(x-\/1.0)\ yields\ the}}
\DoxyCodeLine{00277\ \textcolor{comment}{\ \ \ \ \ *\ appropriate\ sign.}}
\DoxyCodeLine{00278\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00279\ }
\DoxyCodeLine{00280\ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00281\ \textcolor{comment}{\ \ \ \ \ \ *\ Clamp\ rp\ to\ zero\ if\ tx\ <\ 0.}}
\DoxyCodeLine{00282\ \textcolor{comment}{\ \ \ \ \ \ *\ Clamp\ rn\ to\ zero\ if\ tx\ >=\ 0.}}
\DoxyCodeLine{00283\ \textcolor{comment}{\ \ \ \ \ \ */}}
\DoxyCodeLine{00284\ \ \ \ \ m\ =\ sx\ >>\ 63;}
\DoxyCodeLine{00285\ \ \ \ \ rn\ \&=\ m;}
\DoxyCodeLine{00286\ \ \ \ \ rp\ \&=\ \string~m;}
\DoxyCodeLine{00287\ }
\DoxyCodeLine{00288\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00289\ \textcolor{comment}{\ \ \ \ \ *\ Get\ the\ 12\ upper\ bits\ of\ tx;\ if\ they\ are\ not\ all\ zeros\ or}}
\DoxyCodeLine{00290\ \textcolor{comment}{\ \ \ \ \ *\ all\ ones,\ then\ tx\ >=\ 2\string^52\ or\ tx\ <\ -\/2\string^52,\ and\ we\ clamp\ both}}
\DoxyCodeLine{00291\ \textcolor{comment}{\ \ \ \ \ *\ rp\ and\ rn\ to\ zero.\ Otherwise,\ we\ clamp\ tx\ to\ zero.}}
\DoxyCodeLine{00292\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00293\ \ \ \ \ ub\ =\ (uint32\_t)((uint64\_t)tx\ >>\ 52);}
\DoxyCodeLine{00294\ \ \ \ \ m\ =\ -\/(int64\_t)((((ub\ +\ 1)\ \&\ 0xFFF)\ -\/\ 2)\ >>\ 31);}
\DoxyCodeLine{00295\ \ \ \ \ rp\ \&=\ m;}
\DoxyCodeLine{00296\ \ \ \ \ rn\ \&=\ m;}
\DoxyCodeLine{00297\ \ \ \ \ tx\ \&=\ \string~m;}
\DoxyCodeLine{00298\ }
\DoxyCodeLine{00299\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00300\ \textcolor{comment}{\ \ \ \ \ *\ Only\ one\ of\ tx,\ rn\ or\ rp\ (at\ most)\ can\ be\ non-\/zero\ at\ this}}
\DoxyCodeLine{00301\ \textcolor{comment}{\ \ \ \ \ *\ point.}}
\DoxyCodeLine{00302\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00303\ \ \ \ \ \textcolor{keywordflow}{return}\ tx\ |\ rn\ |\ rp;}
\DoxyCodeLine{00304\ \}}
\DoxyCodeLine{00305\ }
\DoxyCodeLine{00306\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ int64\_t\ falcon\_fpr\_floor(falcon\_fpr\ x)}
\DoxyCodeLine{00307\ \{}
\DoxyCodeLine{00308\ \ \ \ \ int64\_t\ r;}
\DoxyCodeLine{00309\ }
\DoxyCodeLine{00310\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00311\ \textcolor{comment}{\ \ \ \ \ *\ The\ cast\ performs\ a\ trunc()\ (rounding\ toward\ 0)\ and\ thus\ is}}
\DoxyCodeLine{00312\ \textcolor{comment}{\ \ \ \ \ *\ wrong\ by\ 1\ for\ most\ negative\ values.\ The\ correction\ below\ is}}
\DoxyCodeLine{00313\ \textcolor{comment}{\ \ \ \ \ *\ constant-\/time\ as\ long\ as\ the\ compiler\ turns\ the}}
\DoxyCodeLine{00314\ \textcolor{comment}{\ \ \ \ \ *\ floating-\/point\ conversion\ result\ into\ a\ 0/1\ integer\ without\ a}}
\DoxyCodeLine{00315\ \textcolor{comment}{\ \ \ \ \ *\ conditional\ branch\ or\ another\ non-\/constant-\/time\ construction.}}
\DoxyCodeLine{00316\ \textcolor{comment}{\ \ \ \ \ *\ This\ should\ hold\ on\ all\ modern\ architectures\ with\ an\ FPU\ (and}}
\DoxyCodeLine{00317\ \textcolor{comment}{\ \ \ \ \ *\ if\ it\ is\ false\ on\ a\ given\ arch,\ then\ chances\ are\ that\ the\ FPU}}
\DoxyCodeLine{00318\ \textcolor{comment}{\ \ \ \ \ *\ itself\ is\ not\ constant-\/time,\ making\ the\ point\ moot).}}
\DoxyCodeLine{00319\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00320\ \ \ \ \ r\ =\ (int64\_t)x.v;}
\DoxyCodeLine{00321\ \ \ \ \ \textcolor{keywordflow}{return}\ r\ -\/\ (x.v\ <\ (double)r);}
\DoxyCodeLine{00322\ \}}
\DoxyCodeLine{00323\ }
\DoxyCodeLine{00324\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ int64\_t\ falcon\_fpr\_trunc(falcon\_fpr\ x)}
\DoxyCodeLine{00325\ \{}
\DoxyCodeLine{00326\ \ \ \ \ \textcolor{keywordflow}{return}\ (int64\_t)x.v;}
\DoxyCodeLine{00327\ \}}
\DoxyCodeLine{00328\ }
\DoxyCodeLine{00329\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ falcon\_fpr\ falcon\_fpr\_add(falcon\_fpr\ x,\ falcon\_fpr\ y)}
\DoxyCodeLine{00330\ \{}
\DoxyCodeLine{00331\ \ \ \ \ \textcolor{keywordflow}{return}\ falcon\_FPR(x.v\ +\ y.v);}
\DoxyCodeLine{00332\ \}}
\DoxyCodeLine{00333\ }
\DoxyCodeLine{00334\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ falcon\_fpr\ falcon\_fpr\_sub(falcon\_fpr\ x,\ falcon\_fpr\ y)}
\DoxyCodeLine{00335\ \{}
\DoxyCodeLine{00336\ \ \ \ \ \textcolor{keywordflow}{return}\ falcon\_FPR(x.v\ -\/\ y.v);}
\DoxyCodeLine{00337\ \}}
\DoxyCodeLine{00338\ }
\DoxyCodeLine{00339\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ falcon\_fpr\ falcon\_fpr\_neg(falcon\_fpr\ x)}
\DoxyCodeLine{00340\ \{}
\DoxyCodeLine{00341\ \ \ \ \ \textcolor{keywordflow}{return}\ falcon\_FPR(-\/x.v);}
\DoxyCodeLine{00342\ \}}
\DoxyCodeLine{00343\ }
\DoxyCodeLine{00344\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ falcon\_fpr\ falcon\_fpr\_half(falcon\_fpr\ x)}
\DoxyCodeLine{00345\ \{}
\DoxyCodeLine{00346\ \ \ \ \ \textcolor{keywordflow}{return}\ falcon\_FPR(x.v\ *\ 0.5);}
\DoxyCodeLine{00347\ \}}
\DoxyCodeLine{00348\ }
\DoxyCodeLine{00349\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ falcon\_fpr\ falcon\_fpr\_double(falcon\_fpr\ x)}
\DoxyCodeLine{00350\ \{}
\DoxyCodeLine{00351\ \ \ \ \ \textcolor{keywordflow}{return}\ falcon\_FPR(x.v\ +\ x.v);}
\DoxyCodeLine{00352\ \}}
\DoxyCodeLine{00353\ }
\DoxyCodeLine{00354\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ falcon\_fpr\ falcon\_fpr\_mul(falcon\_fpr\ x,\ falcon\_fpr\ y)}
\DoxyCodeLine{00355\ \{}
\DoxyCodeLine{00356\ \ \ \ \ \textcolor{keywordflow}{return}\ falcon\_FPR(x.v\ *\ y.v);}
\DoxyCodeLine{00357\ \}}
\DoxyCodeLine{00358\ }
\DoxyCodeLine{00359\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ falcon\_fpr\ falcon\_fpr\_sqr(falcon\_fpr\ x)}
\DoxyCodeLine{00360\ \{}
\DoxyCodeLine{00361\ \ \ \ \ \textcolor{keywordflow}{return}\ falcon\_FPR(x.v\ *\ x.v);}
\DoxyCodeLine{00362\ \}}
\DoxyCodeLine{00363\ }
\DoxyCodeLine{00364\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ falcon\_fpr\ falcon\_fpr\_inv(falcon\_fpr\ x)}
\DoxyCodeLine{00365\ \{}
\DoxyCodeLine{00366\ \ \ \ \ \textcolor{keywordflow}{return}\ falcon\_FPR(1.0\ /\ x.v);}
\DoxyCodeLine{00367\ \}}
\DoxyCodeLine{00368\ }
\DoxyCodeLine{00369\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ falcon\_fpr\ falcon\_fpr\_div(falcon\_fpr\ x,\ falcon\_fpr\ y)}
\DoxyCodeLine{00370\ \{}
\DoxyCodeLine{00371\ \ \ \ \ \textcolor{keywordflow}{return}\ falcon\_FPR(x.v\ /\ y.v);}
\DoxyCodeLine{00372\ \}}
\DoxyCodeLine{00373\ }
\DoxyCodeLine{00374\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ falcon\_fpr\_sqrt\_avx2(\textcolor{keywordtype}{double}\ *t)}
\DoxyCodeLine{00375\ \{}
\DoxyCodeLine{00376\ \ \ \ \ \_\_m128d\ x;}
\DoxyCodeLine{00377\ }
\DoxyCodeLine{00378\ \ \ \ \ x\ =\ \_mm\_load1\_pd(t);}
\DoxyCodeLine{00379\ \ \ \ \ x\ =\ \_mm\_sqrt\_pd(x);}
\DoxyCodeLine{00380\ \ \ \ \ \_mm\_storel\_pd(t,\ x);}
\DoxyCodeLine{00381\ \}}
\DoxyCodeLine{00382\ }
\DoxyCodeLine{00383\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ falcon\_fpr\ falcon\_fpr\_sqrt(falcon\_fpr\ x)}
\DoxyCodeLine{00384\ \{}
\DoxyCodeLine{00385\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00386\ \textcolor{comment}{\ \ \ \ \ *\ We\ prefer\ not\ to\ have\ a\ dependency\ on\ libm\ when\ it\ can\ be}}
\DoxyCodeLine{00387\ \textcolor{comment}{\ \ \ \ \ *\ avoided.\ On\ x86,\ calling\ the\ sqrt()\ libm\ function\ inlines}}
\DoxyCodeLine{00388\ \textcolor{comment}{\ \ \ \ \ *\ the\ relevant\ opcode\ (fsqrt\ or\ sqrtsd,\ depending\ on\ whether}}
\DoxyCodeLine{00389\ \textcolor{comment}{\ \ \ \ \ *\ the\ 387\ FPU\ or\ SSE2\ is\ used\ for\ floating-\/point\ operations)}}
\DoxyCodeLine{00390\ \textcolor{comment}{\ \ \ \ \ *\ but\ then\ makes\ an\ optional\ call\ to\ the\ library\ function}}
\DoxyCodeLine{00391\ \textcolor{comment}{\ \ \ \ \ *\ for\ proper\ error\ handling,\ in\ case\ the\ operand\ is\ negative.}}
\DoxyCodeLine{00392\ \textcolor{comment}{\ \ \ \ \ *}}
\DoxyCodeLine{00393\ \textcolor{comment}{\ \ \ \ \ *\ To\ avoid\ this\ dependency,\ we\ use\ intrinsics\ or\ inline\ assembly}}
\DoxyCodeLine{00394\ \textcolor{comment}{\ \ \ \ \ *\ on\ recognized\ platforms:}}
\DoxyCodeLine{00395\ \textcolor{comment}{\ \ \ \ \ *}}
\DoxyCodeLine{00396\ \textcolor{comment}{\ \ \ \ \ *\ \ -\/\ If\ AVX2\ is\ explicitly\ enabled,\ then\ we\ use\ SSE2\ intrinsics.}}
\DoxyCodeLine{00397\ \textcolor{comment}{\ \ \ \ \ *}}
\DoxyCodeLine{00398\ \textcolor{comment}{\ \ \ \ \ *\ \ -\/\ On\ GCC/Clang\ with\ SSE\ maths,\ we\ use\ SSE2\ intrinsics.}}
\DoxyCodeLine{00399\ \textcolor{comment}{\ \ \ \ \ *}}
\DoxyCodeLine{00400\ \textcolor{comment}{\ \ \ \ \ *\ \ -\/\ On\ GCC/Clang\ on\ i386,\ or\ MSVC\ on\ i386,\ we\ use\ inline\ assembly}}
\DoxyCodeLine{00401\ \textcolor{comment}{\ \ \ \ \ *\ \ \ \ to\ call\ the\ 387\ FPU\ fsqrt\ opcode.}}
\DoxyCodeLine{00402\ \textcolor{comment}{\ \ \ \ \ *}}
\DoxyCodeLine{00403\ \textcolor{comment}{\ \ \ \ \ *\ \ -\/\ On\ GCC/Clang/XLC\ on\ PowerPC,\ we\ use\ inline\ assembly\ to\ call}}
\DoxyCodeLine{00404\ \textcolor{comment}{\ \ \ \ \ *\ \ \ \ the\ fsqrt\ opcode\ (Clang\ needs\ a\ special\ hack).}}
\DoxyCodeLine{00405\ \textcolor{comment}{\ \ \ \ \ *}}
\DoxyCodeLine{00406\ \textcolor{comment}{\ \ \ \ \ *\ \ -\/\ On\ GCC/Clang\ on\ ARM\ with\ hardware\ floating-\/point,\ we\ use}}
\DoxyCodeLine{00407\ \textcolor{comment}{\ \ \ \ \ *\ \ \ \ inline\ assembly\ to\ call\ the\ vqsrt.f64\ opcode.\ Due\ to\ a}}
\DoxyCodeLine{00408\ \textcolor{comment}{\ \ \ \ \ *\ \ \ \ complex\ ecosystem\ of\ compilers\ and\ assembly\ syntaxes,\ we}}
\DoxyCodeLine{00409\ \textcolor{comment}{\ \ \ \ \ *\ \ \ \ have\ to\ call\ it\ "{}fsqrt"{}\ or\ "{}fsqrtd"{},\ depending\ on\ case.}}
\DoxyCodeLine{00410\ \textcolor{comment}{\ \ \ \ \ *}}
\DoxyCodeLine{00411\ \textcolor{comment}{\ \ \ \ \ *\ If\ the\ platform\ is\ not\ recognized,\ a\ call\ to\ the\ system}}
\DoxyCodeLine{00412\ \textcolor{comment}{\ \ \ \ \ *\ library\ function\ sqrt()\ is\ performed.\ On\ some\ compilers,\ this}}
\DoxyCodeLine{00413\ \textcolor{comment}{\ \ \ \ \ *\ may\ actually\ inline\ the\ relevant\ opcode,\ and\ call\ the\ library}}
\DoxyCodeLine{00414\ \textcolor{comment}{\ \ \ \ \ *\ function\ only\ when\ the\ input\ is\ invalid\ (e.g.\ negative);}}
\DoxyCodeLine{00415\ \textcolor{comment}{\ \ \ \ \ *\ Falcon\ never\ actually\ calls\ sqrt()\ on\ a\ negative\ value,\ but}}
\DoxyCodeLine{00416\ \textcolor{comment}{\ \ \ \ \ *\ the\ dependency\ to\ libm\ will\ still\ be\ there.}}
\DoxyCodeLine{00417\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00418\ }
\DoxyCodeLine{00419\ \ \ \ \ falcon\_fpr\_sqrt\_avx2(\&x.v);}
\DoxyCodeLine{00420\ }
\DoxyCodeLine{00421\ \ \ \ \ \textcolor{keywordflow}{return}\ x;}
\DoxyCodeLine{00422\ \}}
\DoxyCodeLine{00423\ }
\DoxyCodeLine{00424\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ int32\_t\ falcon\_fpr\_lt(falcon\_fpr\ x,\ falcon\_fpr\ y)}
\DoxyCodeLine{00425\ \{}
\DoxyCodeLine{00426\ \ \ \ \ \textcolor{keywordflow}{return}\ x.v\ <\ y.v;}
\DoxyCodeLine{00427\ \}}
\DoxyCodeLine{00428\ }
\DoxyCodeLine{00429\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ uint64\_t\ falcon\_fpr\_expm\_p63(falcon\_fpr\ x,\ falcon\_fpr\ ccs)}
\DoxyCodeLine{00430\ \{}
\DoxyCodeLine{00431\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00432\ \textcolor{comment}{\ \ \ \ \ *\ Polynomial\ approximation\ of\ exp(-\/x)\ is\ taken\ from\ FACCT:}}
\DoxyCodeLine{00433\ \textcolor{comment}{\ \ \ \ \ *\ \ \ https://eprint.iacr.org/2018/1234}}
\DoxyCodeLine{00434\ \textcolor{comment}{\ \ \ \ \ *\ Specifically,\ values\ are\ extracted\ from\ the\ implementation}}
\DoxyCodeLine{00435\ \textcolor{comment}{\ \ \ \ \ *\ referenced\ from\ the\ FACCT\ article,\ and\ available\ at:}}
\DoxyCodeLine{00436\ \textcolor{comment}{\ \ \ \ \ *\ \ \ https://github.com/raykzhao/gaussian}}
\DoxyCodeLine{00437\ \textcolor{comment}{\ \ \ \ \ *\ Tests\ over\ more\ than\ 24\ billions\ of\ random\ inputs\ in\ the}}
\DoxyCodeLine{00438\ \textcolor{comment}{\ \ \ \ \ *\ 0..log(2)\ range\ have\ never\ shown\ a\ deviation\ larger\ than}}
\DoxyCodeLine{00439\ \textcolor{comment}{\ \ \ \ \ *\ 2\string^(-\/50)\ from\ the\ true\ mathematical\ value.}}
\DoxyCodeLine{00440\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00441\ }
\DoxyCodeLine{00442\ \ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00443\ \textcolor{comment}{\ \ \ \ \ \ *\ AVX2\ implementation\ uses\ more\ operations\ than\ Horner's\ method,}}
\DoxyCodeLine{00444\ \textcolor{comment}{\ \ \ \ \ \ *\ but\ with\ a\ lower\ expression\ tree\ depth.\ This\ helps\ because}}
\DoxyCodeLine{00445\ \textcolor{comment}{\ \ \ \ \ \ *\ additions\ and\ multiplications\ have\ a\ latency\ of\ 4\ cycles\ on}}
\DoxyCodeLine{00446\ \textcolor{comment}{\ \ \ \ \ \ *\ a\ Skylake,\ but\ the\ CPU\ can\ issue\ two\ of\ them\ per\ cycle.}}
\DoxyCodeLine{00447\ \textcolor{comment}{\ \ \ \ \ \ */}}
\DoxyCodeLine{00448\ }
\DoxyCodeLine{00449\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keyword}{union\ }}
\DoxyCodeLine{00450\ \ \ \ \ \{}
\DoxyCodeLine{00451\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{double}\ d[12];}
\DoxyCodeLine{00452\ \ \ \ \ \ \ \ \ \_\_m256d\ v[3];}
\DoxyCodeLine{00453\ \ \ \ \ \}\ c\ =\ \{}
\DoxyCodeLine{00454\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00455\ \ \ \ \ \ \ \ \ \ \ \ \ 0.999999999999994892974086724280,}
\DoxyCodeLine{00456\ \ \ \ \ \ \ \ \ \ \ \ \ 0.500000000000019206858326015208,}
\DoxyCodeLine{00457\ \ \ \ \ \ \ \ \ \ \ \ \ 0.166666666666984014666397229121,}
\DoxyCodeLine{00458\ \ \ \ \ \ \ \ \ \ \ \ \ 0.041666666666110491190622155955,}
\DoxyCodeLine{00459\ \ \ \ \ \ \ \ \ \ \ \ \ 0.008333333327800835146903501993,}
\DoxyCodeLine{00460\ \ \ \ \ \ \ \ \ \ \ \ \ 0.001388888894063186997887560103,}
\DoxyCodeLine{00461\ \ \ \ \ \ \ \ \ \ \ \ \ 0.000198412739277311890541063977,}
\DoxyCodeLine{00462\ \ \ \ \ \ \ \ \ \ \ \ \ 0.000024801566833585381209939524,}
\DoxyCodeLine{00463\ \ \ \ \ \ \ \ \ \ \ \ \ 0.000002755586350219122514855659,}
\DoxyCodeLine{00464\ \ \ \ \ \ \ \ \ \ \ \ \ 0.000000275607356160477811864927,}
\DoxyCodeLine{00465\ \ \ \ \ \ \ \ \ \ \ \ \ 0.000000025299506379442070029551,}
\DoxyCodeLine{00466\ \ \ \ \ \ \ \ \ \ \ \ \ 0.000000002073772366009083061987}
\DoxyCodeLine{00467\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00468\ \ \ \ \ \};}
\DoxyCodeLine{00469\ }
\DoxyCodeLine{00470\ \ \ \ \ \_\_m256d\ d14;}
\DoxyCodeLine{00471\ \ \ \ \ \_\_m256d\ d58;}
\DoxyCodeLine{00472\ \ \ \ \ \_\_m256d\ d9c;}
\DoxyCodeLine{00473\ \ \ \ \ \textcolor{keywordtype}{double}\ d1;}
\DoxyCodeLine{00474\ \ \ \ \ \textcolor{keywordtype}{double}\ d2;}
\DoxyCodeLine{00475\ \ \ \ \ \textcolor{keywordtype}{double}\ d4;}
\DoxyCodeLine{00476\ \ \ \ \ \textcolor{keywordtype}{double}\ d8;}
\DoxyCodeLine{00477\ \ \ \ \ \textcolor{keywordtype}{double}\ y;}
\DoxyCodeLine{00478\ }
\DoxyCodeLine{00479\ \ \ \ \ d1\ =\ -\/x.v;}
\DoxyCodeLine{00480\ \ \ \ \ d2\ =\ d1\ *\ d1;}
\DoxyCodeLine{00481\ \ \ \ \ d4\ =\ d2\ *\ d2;}
\DoxyCodeLine{00482\ \ \ \ \ d8\ =\ d4\ *\ d4;}
\DoxyCodeLine{00483\ \ \ \ \ d14\ =\ \_mm256\_set\_pd(d4,\ d2\ *\ d1,\ d2,\ d1);}
\DoxyCodeLine{00484\ \ \ \ \ d58\ =\ \_mm256\_mul\_pd(d14,\ \_mm256\_set1\_pd(d4));}
\DoxyCodeLine{00485\ \ \ \ \ d9c\ =\ \_mm256\_mul\_pd(d14,\ \_mm256\_set1\_pd(d8));}
\DoxyCodeLine{00486\ \ \ \ \ d14\ =\ \_mm256\_mul\_pd(d14,\ \_mm256\_loadu\_pd(\&c.d[0]));}
\DoxyCodeLine{00487\ \ \ \ \ d58\ =\ falcon\_fmadd(d58,\ \_mm256\_loadu\_pd(\&c.d[4]),\ d14);}
\DoxyCodeLine{00488\ \ \ \ \ d9c\ =\ falcon\_fmadd(d9c,\ \_mm256\_loadu\_pd(\&c.d[8]),\ d58);}
\DoxyCodeLine{00489\ \ \ \ \ d9c\ =\ \_mm256\_hadd\_pd(d9c,\ d9c);}
\DoxyCodeLine{00490\ \ \ \ \ y\ =\ 1.0\ +\ \_mm\_cvtsd\_f64(\_mm256\_castpd256\_pd128(d9c))\ +\ \_mm\_cvtsd\_f64(\_mm256\_extractf128\_pd(d9c,\ 1));}
\DoxyCodeLine{00491\ \ \ \ \ y\ *=\ ccs.v;}
\DoxyCodeLine{00492\ }
\DoxyCodeLine{00493\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00494\ \textcolor{comment}{\ \ \ \ \ *\ Final\ conversion\ goes\ through\ int64\_t\ first,\ because\ that's\ what}}
\DoxyCodeLine{00495\ \textcolor{comment}{\ \ \ \ \ *\ the\ underlying\ opcode\ (vcvttsd2si)\ will\ do,\ and\ we\ know\ that\ the}}
\DoxyCodeLine{00496\ \textcolor{comment}{\ \ \ \ \ *\ result\ will\ fit,\ since\ x\ >=\ 0\ and\ ccs\ <\ 1.\ If\ we\ did\ the}}
\DoxyCodeLine{00497\ \textcolor{comment}{\ \ \ \ \ *\ conversion\ directly\ to\ uint64\_t,\ then\ the\ compiler\ would\ add\ some}}
\DoxyCodeLine{00498\ \textcolor{comment}{\ \ \ \ \ *\ extra\ code\ to\ cover\ the\ case\ of\ a\ source\ value\ of\ 2\string^63\ or\ more,}}
\DoxyCodeLine{00499\ \textcolor{comment}{\ \ \ \ \ *\ and\ though\ the\ alternate\ path\ would\ never\ be\ exercised,\ the}}
\DoxyCodeLine{00500\ \textcolor{comment}{\ \ \ \ \ *\ extra\ comparison\ would\ cost\ us\ some\ cycles.}}
\DoxyCodeLine{00501\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00502\ \ \ \ \ \textcolor{keywordflow}{return}\ (uint64\_t)(int64\_t)(y\ *\ falcon\_fpr\_ptwo63.v);}
\DoxyCodeLine{00503\ }
\DoxyCodeLine{00504\ \}}
\DoxyCodeLine{00505\ }
\DoxyCodeLine{00506\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{size\_t}\ falcon\_mkn(uint32\_t\ logn)}
\DoxyCodeLine{00507\ \{}
\DoxyCodeLine{00508\ \ \ \ \ \textcolor{keywordflow}{return}\ ((\textcolor{keywordtype}{size\_t})1\ <<\ logn);}
\DoxyCodeLine{00509\ \}}
\DoxyCodeLine{00510\ }
\DoxyCodeLine{00511\ \textcolor{comment}{/*\ fft.c\ */}}
\DoxyCodeLine{00512\ }
\DoxyCodeLine{00513\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ falcon\_fpc\_add(falcon\_fpr*\ d\_re,\ falcon\_fpr*\ d\_im,\ falcon\_fpr\ a\_re,\ falcon\_fpr\ a\_im,\ falcon\_fpr\ b\_re,\ falcon\_fpr\ b\_im)}
\DoxyCodeLine{00514\ \{}
\DoxyCodeLine{00515\ \ \ \ \ falcon\_fpr\ fpct\_re;}
\DoxyCodeLine{00516\ \ \ \ \ falcon\_fpr\ fpct\_im;}
\DoxyCodeLine{00517\ }
\DoxyCodeLine{00518\ \ \ \ \ fpct\_re\ =\ falcon\_fpr\_add(a\_re,\ b\_re);}
\DoxyCodeLine{00519\ \ \ \ \ fpct\_im\ =\ falcon\_fpr\_add(a\_im,\ b\_im);}
\DoxyCodeLine{00520\ \ \ \ \ *d\_re\ =\ fpct\_re;}
\DoxyCodeLine{00521\ \ \ \ \ *d\_im\ =\ fpct\_im;}
\DoxyCodeLine{00522\ \}}
\DoxyCodeLine{00523\ }
\DoxyCodeLine{00524\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ falcon\_fpc\_sub(falcon\_fpr*\ d\_re,\ falcon\_fpr*\ d\_im,\ falcon\_fpr\ a\_re,\ falcon\_fpr\ a\_im,\ falcon\_fpr\ b\_re,\ falcon\_fpr\ b\_im)}
\DoxyCodeLine{00525\ \{}
\DoxyCodeLine{00526\ \ \ \ \ falcon\_fpr\ fpct\_re;}
\DoxyCodeLine{00527\ \ \ \ \ falcon\_fpr\ fpct\_im;}
\DoxyCodeLine{00528\ }
\DoxyCodeLine{00529\ \ \ \ \ fpct\_re\ =\ falcon\_fpr\_sub(a\_re,\ b\_re);}
\DoxyCodeLine{00530\ \ \ \ \ fpct\_im\ =\ falcon\_fpr\_sub(a\_im,\ b\_im);}
\DoxyCodeLine{00531\ \ \ \ \ *d\_re\ =\ fpct\_re;}
\DoxyCodeLine{00532\ \ \ \ \ *d\_im\ =\ fpct\_im;}
\DoxyCodeLine{00533\ \}}
\DoxyCodeLine{00534\ }
\DoxyCodeLine{00535\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ falcon\_fpc\_mul(falcon\_fpr*\ d\_re,\ falcon\_fpr*\ d\_im,\ falcon\_fpr\ a\_re,\ falcon\_fpr\ a\_im,\ falcon\_fpr\ b\_re,\ falcon\_fpr\ b\_im)}
\DoxyCodeLine{00536\ \{}
\DoxyCodeLine{00537\ \ \ \ \ falcon\_fpr\ fpct\_a\_re;}
\DoxyCodeLine{00538\ \ \ \ \ falcon\_fpr\ fpct\_a\_im;}
\DoxyCodeLine{00539\ \ \ \ \ falcon\_fpr\ fpct\_b\_re;}
\DoxyCodeLine{00540\ \ \ \ \ falcon\_fpr\ fpct\_b\_im;}
\DoxyCodeLine{00541\ \ \ \ \ falcon\_fpr\ fpct\_d\_re;}
\DoxyCodeLine{00542\ \ \ \ \ falcon\_fpr\ fpct\_d\_im;}
\DoxyCodeLine{00543\ }
\DoxyCodeLine{00544\ \ \ \ \ fpct\_a\_re\ =\ a\_re;}
\DoxyCodeLine{00545\ \ \ \ \ fpct\_a\_im\ =\ a\_im;}
\DoxyCodeLine{00546\ \ \ \ \ fpct\_b\_re\ =\ b\_re;}
\DoxyCodeLine{00547\ \ \ \ \ fpct\_b\_im\ =\ b\_im;}
\DoxyCodeLine{00548\ \ \ \ \ fpct\_d\_re\ =\ falcon\_fpr\_sub(falcon\_fpr\_mul(fpct\_a\_re,\ fpct\_b\_re),\ falcon\_fpr\_mul(fpct\_a\_im,\ fpct\_b\_im));}
\DoxyCodeLine{00549\ \ \ \ \ fpct\_d\_im\ =\ falcon\_fpr\_add(falcon\_fpr\_mul(fpct\_a\_re,\ fpct\_b\_im),\ falcon\_fpr\_mul(fpct\_a\_im,\ fpct\_b\_re));}
\DoxyCodeLine{00550\ \ \ \ \ *d\_re\ =\ fpct\_d\_re;}
\DoxyCodeLine{00551\ \ \ \ \ *d\_im\ =\ fpct\_d\_im;}
\DoxyCodeLine{00552\ \}}
\DoxyCodeLine{00553\ }
\DoxyCodeLine{00554\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ falcon\_fpc\_div(falcon\_fpr*\ d\_re,\ falcon\_fpr*\ d\_im,\ falcon\_fpr\ a\_re,\ falcon\_fpr\ a\_im,\ falcon\_fpr\ b\_re,\ falcon\_fpr\ b\_im)}
\DoxyCodeLine{00555\ \{}
\DoxyCodeLine{00556\ \ \ \ \ falcon\_fpr\ fpct\_a\_re;}
\DoxyCodeLine{00557\ \ \ \ \ falcon\_fpr\ fpct\_a\_im;}
\DoxyCodeLine{00558\ \ \ \ \ falcon\_fpr\ fpct\_b\_re;}
\DoxyCodeLine{00559\ \ \ \ \ falcon\_fpr\ fpct\_b\_im;}
\DoxyCodeLine{00560\ \ \ \ \ falcon\_fpr\ fpct\_d\_re;}
\DoxyCodeLine{00561\ \ \ \ \ falcon\_fpr\ fpct\_d\_im;}
\DoxyCodeLine{00562\ \ \ \ \ falcon\_fpr\ fpct\_m;}
\DoxyCodeLine{00563\ }
\DoxyCodeLine{00564\ \ \ \ \ fpct\_a\_re\ =\ a\_re;}
\DoxyCodeLine{00565\ \ \ \ \ fpct\_a\_im\ =\ a\_im;}
\DoxyCodeLine{00566\ \ \ \ \ fpct\_b\_re\ =\ b\_re;}
\DoxyCodeLine{00567\ \ \ \ \ fpct\_b\_im\ =\ b\_im;}
\DoxyCodeLine{00568\ \ \ \ \ fpct\_m\ =\ falcon\_fpr\_add(falcon\_fpr\_sqr(fpct\_b\_re),\ falcon\_fpr\_sqr(fpct\_b\_im));}
\DoxyCodeLine{00569\ \ \ \ \ fpct\_m\ =\ falcon\_fpr\_inv(fpct\_m);}
\DoxyCodeLine{00570\ \ \ \ \ fpct\_b\_re\ =\ falcon\_fpr\_mul(fpct\_b\_re,\ fpct\_m);}
\DoxyCodeLine{00571\ \ \ \ \ fpct\_b\_im\ =\ falcon\_fpr\_mul(falcon\_fpr\_neg(fpct\_b\_im),\ fpct\_m);}
\DoxyCodeLine{00572\ \ \ \ \ fpct\_d\_re\ =\ falcon\_fpr\_sub(falcon\_fpr\_mul(fpct\_a\_re,\ fpct\_b\_re),\ falcon\_fpr\_mul(fpct\_a\_im,\ fpct\_b\_im));}
\DoxyCodeLine{00573\ \ \ \ \ fpct\_d\_im\ =\ falcon\_fpr\_add(falcon\_fpr\_mul(fpct\_a\_re,\ fpct\_b\_im),\ falcon\_fpr\_mul(fpct\_a\_im,\ fpct\_b\_re));}
\DoxyCodeLine{00574\ \ \ \ \ *d\_re\ =\ fpct\_d\_re;}
\DoxyCodeLine{00575\ \ \ \ \ *d\_im\ =\ fpct\_d\_im;}
\DoxyCodeLine{00576\ \}}
\DoxyCodeLine{00577\ }
\DoxyCodeLine{00578\ \textcolor{comment}{/*\ codec.c\ */}}
\DoxyCodeLine{00579\ }
\DoxyCodeLine{00580\ \textcolor{keyword}{extern}\ \textcolor{keyword}{const}\ uint8\_t\ falcon\_avx2\_max\_fg\_bits[FALCON\_MAXBITS\_SIZE];}
\DoxyCodeLine{00581\ \textcolor{keyword}{extern}\ \textcolor{keyword}{const}\ uint8\_t\ falcon\_falcon\_max\_FG\_bits[FALCON\_MAXBITS\_SIZE];}
\DoxyCodeLine{00582\ }
\DoxyCodeLine{00583\ \textcolor{comment}{/*\ sign.c\ */}}
\DoxyCodeLine{00584\ }
\DoxyCodeLine{00585\ \textcolor{keyword}{typedef}\ \textcolor{keyword}{struct}}
\DoxyCodeLine{00586\ \{}
\DoxyCodeLine{00587\ \ \ \ \ falcon\_prng\_state\ p;}
\DoxyCodeLine{00588\ \ \ \ \ falcon\_fpr\ sigma\_min;}
\DoxyCodeLine{00589\ \}\ falcon\_sampler\_context;}
\DoxyCodeLine{00590\ }
\DoxyCodeLine{00591\ \textcolor{keyword}{typedef}\ int32\_t(*falcon\_samplerZ)(\textcolor{keywordtype}{void}*\ ctx,\ falcon\_fpr\ mu,\ falcon\_fpr\ sigma);}
\DoxyCodeLine{00592\ }
\DoxyCodeLine{00593\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ uint32\_t\ falcon\_ffLDL\_treesize(uint32\_t\ logn)}
\DoxyCodeLine{00594\ \{}
\DoxyCodeLine{00595\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00596\ \textcolor{comment}{\ \ \ \ *\ Get\ the\ size\ of\ the\ LDL\ tree\ for\ an\ input\ with\ polynomials\ of\ size}}
\DoxyCodeLine{00597\ \textcolor{comment}{\ \ \ \ *\ 2\string^logn.\ The\ size\ is\ expressed\ in\ the\ number\ of\ elements.}}
\DoxyCodeLine{00598\ \textcolor{comment}{\ \ \ \ *\ For\ logn\ =\ 0\ (polynomials\ are\ constant),\ the\ "{}tree"{}\ is\ a}}
\DoxyCodeLine{00599\ \textcolor{comment}{\ \ \ \ *\ single\ element.\ Otherwise,\ the\ tree\ node\ has\ size\ 2\string^logn,\ and}}
\DoxyCodeLine{00600\ \textcolor{comment}{\ \ \ \ *\ has\ two\ child\ trees\ for\ size\ logn-\/1\ each.\ Thus,\ treesize\ s()}}
\DoxyCodeLine{00601\ \textcolor{comment}{\ \ \ \ *\ must\ fulfill\ these\ two\ relations:}}
\DoxyCodeLine{00602\ \textcolor{comment}{\ \ \ \ *}}
\DoxyCodeLine{00603\ \textcolor{comment}{\ \ \ \ *\ \ \ s(0)\ =\ 1}}
\DoxyCodeLine{00604\ \textcolor{comment}{\ \ \ \ *\ \ \ s(logn)\ =\ (2\string^logn)\ +\ 2*s(logn-\/1)}}
\DoxyCodeLine{00605\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{00606\ }
\DoxyCodeLine{00607\ \ \ \ \ \textcolor{keywordflow}{return}\ (logn\ +\ 1)\ <<\ logn;}
\DoxyCodeLine{00608\ \}}
\DoxyCodeLine{00609\ }
\DoxyCodeLine{00610\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{size\_t}\ falcon\_skoff\_b00(uint32\_t\ logn)}
\DoxyCodeLine{00611\ \{}
\DoxyCodeLine{00612\ \ \ \ \ (void)logn;}
\DoxyCodeLine{00613\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00614\ \}}
\DoxyCodeLine{00615\ }
\DoxyCodeLine{00616\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{size\_t}\ falcon\_skoff\_b01(uint32\_t\ logn)}
\DoxyCodeLine{00617\ \{}
\DoxyCodeLine{00618\ \ \ \ \ \textcolor{keywordflow}{return}\ falcon\_mkn(logn);}
\DoxyCodeLine{00619\ \}}
\DoxyCodeLine{00620\ }
\DoxyCodeLine{00621\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{size\_t}\ falcon\_skoff\_b10(uint32\_t\ logn)}
\DoxyCodeLine{00622\ \{}
\DoxyCodeLine{00623\ \ \ \ \ \textcolor{keywordflow}{return}\ 2\ *\ falcon\_mkn(logn);}
\DoxyCodeLine{00624\ \}}
\DoxyCodeLine{00625\ }
\DoxyCodeLine{00626\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{size\_t}\ falcon\_skoff\_b11(uint32\_t\ logn)}
\DoxyCodeLine{00627\ \{}
\DoxyCodeLine{00628\ \ \ \ \ \textcolor{keywordflow}{return}\ 3\ *\ falcon\_mkn(logn);}
\DoxyCodeLine{00629\ \}}
\DoxyCodeLine{00630\ }
\DoxyCodeLine{00631\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{size\_t}\ falcon\_skoff\_tree(uint32\_t\ logn)}
\DoxyCodeLine{00632\ \{}
\DoxyCodeLine{00633\ \ \ \ \ \textcolor{keywordflow}{return}\ 4\ *\ falcon\_mkn(logn);}
\DoxyCodeLine{00634\ \}}
\DoxyCodeLine{00635\ }
\DoxyCodeLine{00636\ \textcolor{comment}{/*\ keygen.c\ */}}
\DoxyCodeLine{00637\ }
\DoxyCodeLine{00638\ \textcolor{keyword}{extern}\ \textcolor{keyword}{const}\ uint32\_t\ falcon\_avx2\_l2bound[FALCON\_L2BOUND\_SIZE];}
\DoxyCodeLine{00639\ }
\DoxyCodeLine{00640\ \textcolor{keyword}{extern}\ \textcolor{keyword}{const}\ uint64\_t\ falcon\_avx2\_gauss\_1024\_12289[FALCON\_GAUS\_1024\_12289\_SIZE];}
\DoxyCodeLine{00641\ }
\DoxyCodeLine{00642\ \textcolor{keyword}{extern}\ \textcolor{keyword}{const}\ uint16\_t\ falcon\_avx2\_falcon\_rev10[FALCON\_REV10\_SIZE];}
\DoxyCodeLine{00643\ }
\DoxyCodeLine{00644\ \textcolor{keyword}{extern}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ falcon\_avx2\_max\_bl\_small[FALCON\_MAX\_BL\_SMALL\_SIZE];}
\DoxyCodeLine{00645\ }
\DoxyCodeLine{00646\ \textcolor{keyword}{extern}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ falcon\_avx2\_max\_bl\_large[FALCON\_MAX\_BL\_LARGE\_SIZE];}
\DoxyCodeLine{00647\ }
\DoxyCodeLine{00648\ \textcolor{comment}{/*}}
\DoxyCodeLine{00649\ \textcolor{comment}{\ *\ Average\ and\ standard\ deviation\ for\ the\ maximum\ size\ (in\ bits)\ of}}
\DoxyCodeLine{00650\ \textcolor{comment}{\ *\ coefficients\ of\ (f,g),\ depending\ on\ depth.\ These\ values\ are\ used}}
\DoxyCodeLine{00651\ \textcolor{comment}{\ *\ to\ compute\ bounds\ for\ Babai's\ reduction.}}
\DoxyCodeLine{00652\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00653\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keyword}{struct\ }\{}
\DoxyCodeLine{00654\ \ \ \ \ int32\_t\ avg;}
\DoxyCodeLine{00655\ \ \ \ \ int32\_t\ std;}
\DoxyCodeLine{00656\ \}\ falcon\_bit\_length[]\ =\ \{}
\DoxyCodeLine{00657\ \ \ \ \ \{\ \ \ \ 4,\ \ 0\ \},}
\DoxyCodeLine{00658\ \ \ \ \ \{\ \ \ 11,\ \ 1\ \},}
\DoxyCodeLine{00659\ \ \ \ \ \{\ \ \ 24,\ \ 1\ \},}
\DoxyCodeLine{00660\ \ \ \ \ \{\ \ \ 50,\ \ 1\ \},}
\DoxyCodeLine{00661\ \ \ \ \ \{\ \ 102,\ \ 1\ \},}
\DoxyCodeLine{00662\ \ \ \ \ \{\ \ 202,\ \ 2\ \},}
\DoxyCodeLine{00663\ \ \ \ \ \{\ \ 401,\ \ 4\ \},}
\DoxyCodeLine{00664\ \ \ \ \ \{\ \ 794,\ \ 5\ \},}
\DoxyCodeLine{00665\ \ \ \ \ \{\ 1577,\ \ 8\ \},}
\DoxyCodeLine{00666\ \ \ \ \ \{\ 3138,\ 13\ \},}
\DoxyCodeLine{00667\ \ \ \ \ \{\ 6308,\ 25\ \}}
\DoxyCodeLine{00668\ \};}
\DoxyCodeLine{00669\ }
\DoxyCodeLine{00670\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ uint32\_t\ falcon\_modp\_set(int32\_t\ x,\ uint32\_t\ p)}
\DoxyCodeLine{00671\ \{}
\DoxyCodeLine{00672\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00673\ \textcolor{comment}{\ \ \ \ *\ Reduce\ a\ small\ signed\ integer\ modulo\ a\ small\ prime.\ The\ source}}
\DoxyCodeLine{00674\ \textcolor{comment}{\ \ \ \ *\ value\ x\ MUST\ be\ such\ that\ -\/p\ <\ x\ <\ p.}}
\DoxyCodeLine{00675\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{00676\ }
\DoxyCodeLine{00677\ \ \ \ \ uint32\_t\ w;}
\DoxyCodeLine{00678\ }
\DoxyCodeLine{00679\ \ \ \ \ w\ =\ (uint32\_t)x;}
\DoxyCodeLine{00680\ \ \ \ \ w\ +=\ p\ \&\ (uint32\_t)-\/(int32\_t)(w\ >>\ 31);}
\DoxyCodeLine{00681\ \ \ \ \ \textcolor{keywordflow}{return}\ w;}
\DoxyCodeLine{00682\ \}}
\DoxyCodeLine{00683\ }
\DoxyCodeLine{00684\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ int32\_t\ falcon\_modp\_norm(uint32\_t\ x,\ uint32\_t\ p)}
\DoxyCodeLine{00685\ \{}
\DoxyCodeLine{00686\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00687\ \textcolor{comment}{\ \ \ \ *\ Normalize\ a\ modular\ integer\ around\ 0.}}
\DoxyCodeLine{00688\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{00689\ }
\DoxyCodeLine{00690\ \ \ \ \ \textcolor{keywordflow}{return}\ (int32\_t)(x\ -\/\ (p\ \&\ (((x\ -\/\ ((p\ +\ 1)\ >>\ 1))\ >>\ 31)\ -\/\ 1)));}
\DoxyCodeLine{00691\ \}}
\DoxyCodeLine{00692\ }
\DoxyCodeLine{00693\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ uint32\_t\ falcon\_modp\_ninv31(uint32\_t\ p)}
\DoxyCodeLine{00694\ \{}
\DoxyCodeLine{00695\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00696\ \textcolor{comment}{\ \ \ \ *\ Compute\ -\/1/p\ mod\ 2\string^31.\ This\ works\ for\ all\ odd\ integers\ p\ that\ fit\ on\ 31\ bits.}}
\DoxyCodeLine{00697\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{00698\ \ \ \ \ uint32\_t\ y;}
\DoxyCodeLine{00699\ }
\DoxyCodeLine{00700\ \ \ \ \ y\ =\ 2\ -\/\ p;}
\DoxyCodeLine{00701\ \ \ \ \ y\ *=\ 2\ -\/\ p\ *\ y;}
\DoxyCodeLine{00702\ \ \ \ \ y\ *=\ 2\ -\/\ p\ *\ y;}
\DoxyCodeLine{00703\ \ \ \ \ y\ *=\ 2\ -\/\ p\ *\ y;}
\DoxyCodeLine{00704\ \ \ \ \ y\ *=\ 2\ -\/\ p\ *\ y;}
\DoxyCodeLine{00705\ }
\DoxyCodeLine{00706\ \ \ \ \ \textcolor{keywordflow}{return}\ (uint32\_t)0x7FFFFFFFUL\ \&\ (uint32\_t)-\/(int32\_t)y;}
\DoxyCodeLine{00707\ \}}
\DoxyCodeLine{00708\ }
\DoxyCodeLine{00709\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ uint32\_t\ falcon\_modp\_R(uint32\_t\ p)}
\DoxyCodeLine{00710\ \{}
\DoxyCodeLine{00711\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00712\ \textcolor{comment}{\ \ \ \ *\ Since\ 2\string^30\ <\ p\ <\ 2\string^31,\ we\ know\ that\ 2\string^31\ mod\ p\ is\ simply\ 2\string^31\ -\/\ p.}}
\DoxyCodeLine{00713\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{00714\ }
\DoxyCodeLine{00715\ \ \ \ \ \textcolor{keywordflow}{return}\ ((uint32\_t)1\ <<\ 31)\ -\/\ p;}
\DoxyCodeLine{00716\ \}}
\DoxyCodeLine{00717\ }
\DoxyCodeLine{00718\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ uint32\_t\ falcon\_modp\_add(uint32\_t\ a,\ uint32\_t\ b,\ uint32\_t\ p)}
\DoxyCodeLine{00719\ \{}
\DoxyCodeLine{00720\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00721\ \textcolor{comment}{\ \ \ \ *\ Addition\ modulo\ p.}}
\DoxyCodeLine{00722\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{00723\ }
\DoxyCodeLine{00724\ \ \ \ \ uint32\_t\ d;}
\DoxyCodeLine{00725\ }
\DoxyCodeLine{00726\ \ \ \ \ d\ =\ a\ +\ b\ -\/\ p;}
\DoxyCodeLine{00727\ \ \ \ \ d\ +=\ p\ \&\ (uint32\_t)-\/(int32\_t)(d\ >>\ 31);}
\DoxyCodeLine{00728\ }
\DoxyCodeLine{00729\ \ \ \ \ \textcolor{keywordflow}{return}\ d;}
\DoxyCodeLine{00730\ \}}
\DoxyCodeLine{00731\ }
\DoxyCodeLine{00732\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ uint32\_t\ falcon\_modp\_sub(uint32\_t\ a,\ uint32\_t\ b,\ uint32\_t\ p)}
\DoxyCodeLine{00733\ \{}
\DoxyCodeLine{00734\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00735\ \textcolor{comment}{\ \ \ \ *\ Subtraction\ modulo\ p.}}
\DoxyCodeLine{00736\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{00737\ }
\DoxyCodeLine{00738\ \ \ \ \ uint32\_t\ d;}
\DoxyCodeLine{00739\ }
\DoxyCodeLine{00740\ \ \ \ \ d\ =\ a\ -\/\ b;}
\DoxyCodeLine{00741\ \ \ \ \ d\ +=\ p\ \&\ (uint32\_t)-\/(int32\_t)(d\ >>\ 31);}
\DoxyCodeLine{00742\ }
\DoxyCodeLine{00743\ \ \ \ \ \textcolor{keywordflow}{return}\ d;}
\DoxyCodeLine{00744\ \}}
\DoxyCodeLine{00745\ }
\DoxyCodeLine{00746\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ uint32\_t\ falcon\_modp\_montymul(uint32\_t\ a,\ uint32\_t\ b,\ uint32\_t\ p,\ uint32\_t\ p0i)}
\DoxyCodeLine{00747\ \{}
\DoxyCodeLine{00748\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00749\ \textcolor{comment}{\ \ \ \ *\ Montgomery\ multiplication\ modulo\ p.\ The\ 'p0i'\ value\ is\ -\/1/p\ mod\ 2\string^31.}}
\DoxyCodeLine{00750\ \textcolor{comment}{\ \ \ \ *\ It\ is\ required\ that\ p\ is\ an\ odd\ integer.}}
\DoxyCodeLine{00751\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{00752\ }
\DoxyCodeLine{00753\ \ \ \ \ uint64\_t\ w;}
\DoxyCodeLine{00754\ \ \ \ \ uint64\_t\ z;}
\DoxyCodeLine{00755\ \ \ \ \ uint32\_t\ d;}
\DoxyCodeLine{00756\ }
\DoxyCodeLine{00757\ \ \ \ \ z\ =\ (uint64\_t)a\ *\ (uint64\_t)b;}
\DoxyCodeLine{00758\ \ \ \ \ w\ =\ ((z\ *\ p0i)\ \&\ (uint64\_t)0x7FFFFFFF)\ *\ p;}
\DoxyCodeLine{00759\ \ \ \ \ d\ =\ (uint32\_t)((z\ +\ w)\ >>\ 31)\ -\/\ p;}
\DoxyCodeLine{00760\ \ \ \ \ d\ +=\ p\ \&\ (uint32\_t)-\/(int32\_t)(d\ >>\ 31);}
\DoxyCodeLine{00761\ }
\DoxyCodeLine{00762\ \ \ \ \ \textcolor{keywordflow}{return}\ d;}
\DoxyCodeLine{00763\ \}}
\DoxyCodeLine{00764\ }
\DoxyCodeLine{00765\ \textcolor{comment}{/*\ verify.c\ */}}
\DoxyCodeLine{00766\ }
\DoxyCodeLine{00767\ \textcolor{keyword}{typedef}\ \textcolor{keyword}{struct}}
\DoxyCodeLine{00768\ \{}
\DoxyCodeLine{00769\ \ \ \ \ uint32\_t\ p;}
\DoxyCodeLine{00770\ \ \ \ \ uint32\_t\ g;}
\DoxyCodeLine{00771\ \ \ \ \ uint32\_t\ s;}
\DoxyCodeLine{00772\ \}\ falcon\_small\_prime;}
\DoxyCodeLine{00773\ }
\DoxyCodeLine{00774\ \textcolor{keyword}{extern}\ \textcolor{keyword}{const}\ uint16\_t\ falcon\_avx2\_GMb[FALCON\_GMB\_SIZE];}
\DoxyCodeLine{00775\ }
\DoxyCodeLine{00776\ \textcolor{keyword}{extern}\ \textcolor{keyword}{const}\ uint16\_t\ falcon\_avx2\_iGMb[FALCON\_GMB\_SIZE];}
\DoxyCodeLine{00777\ }
\DoxyCodeLine{00778\ \textcolor{keyword}{extern}\ \textcolor{keyword}{const}\ falcon\_small\_prime\ falcon\_avx2\_small\_primes[FALCON\_SMALL\_PRIME\_SIZE];}
\DoxyCodeLine{00779\ }
\DoxyCodeLine{00780\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ uint32\_t\ falcon\_mq\_conv\_small(int32\_t\ x)}
\DoxyCodeLine{00781\ \{}
\DoxyCodeLine{00782\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00783\ \textcolor{comment}{\ \ \ \ *\ Reduce\ a\ small\ signed\ integer\ modulo\ q.\ The\ source\ integer\ MUST}}
\DoxyCodeLine{00784\ \textcolor{comment}{\ \ \ \ *\ be\ between\ -\/q/2\ and\ +q/2.}}
\DoxyCodeLine{00785\ \textcolor{comment}{\ \ \ \ *\ If\ x\ <\ 0,\ the\ cast\ to\ uint32\_t\ will\ set\ the\ high\ bit\ to\ 1.}}
\DoxyCodeLine{00786\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{00787\ \ \ \ \ uint32\_t\ y;}
\DoxyCodeLine{00788\ }
\DoxyCodeLine{00789\ \ \ \ \ y\ =\ (uint32\_t)x;}
\DoxyCodeLine{00790\ \ \ \ \ y\ +=\ FALCON\_Q\ \&\ (uint32\_t)-\/(int32\_t)(y\ >>\ 31);}
\DoxyCodeLine{00791\ }
\DoxyCodeLine{00792\ \ \ \ \ \textcolor{keywordflow}{return}\ y;}
\DoxyCodeLine{00793\ \}}
\DoxyCodeLine{00794\ }
\DoxyCodeLine{00795\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ uint32\_t\ falcon\_mq\_add(uint32\_t\ x,\ uint32\_t\ y)}
\DoxyCodeLine{00796\ \{}
\DoxyCodeLine{00797\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00798\ \textcolor{comment}{\ \ \ \ \ *\ Addition\ modulo\ q.\ Operands\ must\ be\ in\ the\ 0..q-\/1\ range.}}
\DoxyCodeLine{00799\ \textcolor{comment}{\ \ \ \ *\ We\ compute\ x\ +\ y\ -\/\ q.\ If\ the\ result\ is\ negative,\ then\ the}}
\DoxyCodeLine{00800\ \textcolor{comment}{\ \ \ \ *\ high\ bit\ will\ be\ set,\ and\ 'd\ >>\ 31'\ will\ be\ equal\ to\ 1;}}
\DoxyCodeLine{00801\ \textcolor{comment}{\ \ \ \ *\ thus\ '-\/(d\ >>\ 31)'\ will\ be\ an\ all-\/one\ pattern.\ Otherwise,}}
\DoxyCodeLine{00802\ \textcolor{comment}{\ \ \ \ *\ it\ will\ be\ an\ all-\/zero\ pattern.\ In\ other\ words,\ this}}
\DoxyCodeLine{00803\ \textcolor{comment}{\ \ \ \ *\ implements\ a\ conditional\ addition\ of\ q.}}
\DoxyCodeLine{00804\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{00805\ \ \ \ \ uint32\_t\ d;}
\DoxyCodeLine{00806\ }
\DoxyCodeLine{00807\ \ \ \ \ d\ =\ x\ +\ y\ -\/\ FALCON\_Q;}
\DoxyCodeLine{00808\ \ \ \ \ d\ +=\ FALCON\_Q\ \&\ (uint32\_t)-\/(int32\_t)(d\ >>\ 31);}
\DoxyCodeLine{00809\ }
\DoxyCodeLine{00810\ \ \ \ \ \textcolor{keywordflow}{return}\ d;}
\DoxyCodeLine{00811\ \}}
\DoxyCodeLine{00812\ }
\DoxyCodeLine{00813\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ uint32\_t\ falcon\_mq\_sub(uint32\_t\ x,\ uint32\_t\ y)}
\DoxyCodeLine{00814\ \{}
\DoxyCodeLine{00815\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00816\ \textcolor{comment}{\ \ \ \ *\ Subtraction\ modulo\ q.\ Operands\ must\ be\ in\ the\ 0..q-\/1\ range.}}
\DoxyCodeLine{00817\ \textcolor{comment}{\ \ \ \ *\ As\ in\ falcon\_mq\_add(),\ we\ use\ a\ conditional\ addition\ to\ ensure\ the}}
\DoxyCodeLine{00818\ \textcolor{comment}{\ \ \ \ *\ result\ is\ in\ the\ 0..q-\/1\ range.}}
\DoxyCodeLine{00819\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{00820\ }
\DoxyCodeLine{00821\ \ \ \ \ uint32\_t\ d;}
\DoxyCodeLine{00822\ }
\DoxyCodeLine{00823\ \ \ \ \ d\ =\ x\ -\/\ y;}
\DoxyCodeLine{00824\ \ \ \ \ d\ +=\ FALCON\_Q\ \&\ (uint32\_t)-\/(int32\_t)(d\ >>\ 31);}
\DoxyCodeLine{00825\ }
\DoxyCodeLine{00826\ \ \ \ \ \textcolor{keywordflow}{return}\ d;}
\DoxyCodeLine{00827\ \}}
\DoxyCodeLine{00828\ }
\DoxyCodeLine{00829\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ uint32\_t\ falcon\_mq\_rshift1(uint32\_t\ x)}
\DoxyCodeLine{00830\ \{}
\DoxyCodeLine{00831\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00832\ \textcolor{comment}{\ \ \ \ *\ Division\ by\ 2\ modulo\ q.\ Operand\ must\ be\ in\ the\ 0..q-\/1\ range.}}
\DoxyCodeLine{00833\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{00834\ }
\DoxyCodeLine{00835\ \ \ \ \ x\ +=\ FALCON\_Q\ \&\ (uint32\_t)-\/(int32\_t)(x\ \&\ 1);}
\DoxyCodeLine{00836\ \ \ \ \ \textcolor{keywordflow}{return}\ (x\ >>\ 1);}
\DoxyCodeLine{00837\ \}}
\DoxyCodeLine{00838\ }
\DoxyCodeLine{00839\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ uint32\_t\ falcon\_mq\_montymul(uint32\_t\ x,\ uint32\_t\ y)}
\DoxyCodeLine{00840\ \{}
\DoxyCodeLine{00841\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00842\ \textcolor{comment}{\ \ \ \ *\ Montgomery\ multiplication\ modulo\ q.\ If\ we\ set\ R\ =\ 2\string^16\ mod\ q,\ then}}
\DoxyCodeLine{00843\ \textcolor{comment}{\ \ \ \ *\ this\ function\ computes:\ x\ *\ y\ /\ R\ mod\ q}}
\DoxyCodeLine{00844\ \textcolor{comment}{\ \ \ \ *\ Operands\ must\ be\ in\ the\ 0..q-\/1\ range.}}
\DoxyCodeLine{00845\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{00846\ }
\DoxyCodeLine{00847\ \ \ \ \ uint32\_t\ w;}
\DoxyCodeLine{00848\ \ \ \ \ uint32\_t\ z;}
\DoxyCodeLine{00849\ }
\DoxyCodeLine{00850\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00851\ \textcolor{comment}{\ \ \ \ \ *\ We\ compute\ x*y\ +\ k*q\ with\ a\ value\ of\ k\ chosen\ so\ that\ the\ 16}}
\DoxyCodeLine{00852\ \textcolor{comment}{\ \ \ \ \ *\ low\ bits\ of\ the\ result\ are\ 0.\ We\ can\ then\ shift\ the\ value.}}
\DoxyCodeLine{00853\ \textcolor{comment}{\ \ \ \ \ *\ After\ the\ shift,\ result\ may\ still\ be\ larger\ than\ q,\ but\ it}}
\DoxyCodeLine{00854\ \textcolor{comment}{\ \ \ \ \ *\ will\ be\ lower\ than\ 2*q,\ so\ a\ conditional\ subtraction\ works.}}
\DoxyCodeLine{00855\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00856\ }
\DoxyCodeLine{00857\ \ \ \ \ z\ =\ x\ *\ y;}
\DoxyCodeLine{00858\ \ \ \ \ w\ =\ ((z\ *\ FALCON\_Q0I)\ \&\ 0x0000FFFFUL)\ *\ FALCON\_Q;}
\DoxyCodeLine{00859\ }
\DoxyCodeLine{00860\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00861\ \textcolor{comment}{\ \ \ \ \ *\ When\ adding\ z\ and\ w,\ the\ result\ will\ have\ its\ low\ 16\ bits}}
\DoxyCodeLine{00862\ \textcolor{comment}{\ \ \ \ \ *\ equal\ to\ 0.\ Since\ x,\ y\ and\ z\ are\ lower\ than\ q,\ the\ sum\ will}}
\DoxyCodeLine{00863\ \textcolor{comment}{\ \ \ \ \ *\ be\ no\ more\ than\ (2\string^15\ -\/\ 1)\ *\ q\ +\ (q\ -\/\ 1)\string^2,\ which\ will}}
\DoxyCodeLine{00864\ \textcolor{comment}{\ \ \ \ \ *\ fit\ on\ 29\ bits.}}
\DoxyCodeLine{00865\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00866\ \ \ \ \ z\ =\ (z\ +\ w)\ >>\ 16;}
\DoxyCodeLine{00867\ }
\DoxyCodeLine{00868\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00869\ \textcolor{comment}{\ \ \ \ \ *\ After\ the\ shift,\ analysis\ shows\ that\ the\ value\ will\ be\ less}}
\DoxyCodeLine{00870\ \textcolor{comment}{\ \ \ \ \ *\ than\ 2q.\ We\ do\ a\ subtraction\ then\ conditional\ subtraction\ to}}
\DoxyCodeLine{00871\ \textcolor{comment}{\ \ \ \ \ *\ ensure\ the\ result\ is\ in\ the\ expected\ range.}}
\DoxyCodeLine{00872\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00873\ \ \ \ \ z\ -\/=\ FALCON\_Q;}
\DoxyCodeLine{00874\ \ \ \ \ z\ +=\ FALCON\_Q\ \&\ (uint32\_t)-\/(int32\_t)(z\ >>\ 31);}
\DoxyCodeLine{00875\ \ \ \ \ \textcolor{keywordflow}{return}\ z;}
\DoxyCodeLine{00876\ \}}
\DoxyCodeLine{00877\ }
\DoxyCodeLine{00878\ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ uint32\_t\ falcon\_mq\_montysqr(uint32\_t\ x)}
\DoxyCodeLine{00879\ \{}
\DoxyCodeLine{00880\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00881\ \textcolor{comment}{\ \ \ \ *\ Montgomery\ squaring\ (computes\ (x\string^2)/R).}}
\DoxyCodeLine{00882\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{00883\ }
\DoxyCodeLine{00884\ \ \ \ \ \textcolor{keywordflow}{return}\ falcon\_mq\_montymul(x,\ x);}
\DoxyCodeLine{00885\ \}}
\DoxyCodeLine{00886\ }
\DoxyCodeLine{00887\ }
\DoxyCodeLine{00896\ int32\_t\ qsc\_falcon\_avx2\_generate\_keypair(uint8\_t\ *pk,\ uint8\_t\ *sk,\ \textcolor{keywordtype}{bool}\ (*rng\_generate)(uint8\_t*,\ \textcolor{keywordtype}{size\_t}));}
\DoxyCodeLine{00897\ }
\DoxyCodeLine{00908\ int32\_t\ qsc\_falcon\_avx2\_sign(uint8\_t\ *sm,\ \textcolor{keywordtype}{size\_t}\ *smlen,\ \textcolor{keyword}{const}\ uint8\_t\ *m,\ \textcolor{keywordtype}{size\_t}\ mlen,\ \textcolor{keyword}{const}\ uint8\_t\ *sk,\ \textcolor{keywordtype}{bool}\ (*rng\_generate)(uint8\_t*,\ \textcolor{keywordtype}{size\_t}));}
\DoxyCodeLine{00909\ }
\DoxyCodeLine{00920\ \textcolor{keywordtype}{bool}\ qsc\_falcon\_avx2\_open(uint8\_t\ *m,\ \textcolor{keywordtype}{size\_t}\ *mlen,\ \textcolor{keyword}{const}\ uint8\_t\ *sm,\ \textcolor{keywordtype}{size\_t}\ smlen,\ \textcolor{keyword}{const}\ uint8\_t\ *pk);}
\DoxyCodeLine{00921\ }
\DoxyCodeLine{00922\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00923\ \textcolor{comment}{/*\ \(\backslash\)endcond\ DOXYGEN\_IGNORE\ */}}
\DoxyCodeLine{00924\ \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
