#include "ntt.h"

int16_t zetas[128] = 
{
	0x08EDU, 0x0A0BU, 0x0B9AU, 0x0714U, 0x05D5U, 0x058EU, 0x011FU, 0x00CAU, 0x0C56U, 0x026EU, 0x0629U, 0x00B6U, 0x03C2U, 0x084FU, 0x073FU, 0x05BCU,
	0x023DU, 0x07D4U, 0x0108U, 0x017FU, 0x09C4U, 0x05B2U, 0x06BFU, 0x0C7FU, 0x0A58U, 0x03F9U, 0x02DCU, 0x0260U, 0x06FBU, 0x019BU, 0x0C34U, 0x06DEU,
	0x04C7U, 0x028CU, 0x0AD9U, 0x03F7U, 0x07F4U, 0x05D3U, 0x0BE7U, 0x06F9U, 0x0204U, 0x0CF9U, 0x0BC1U, 0x0A67U, 0x06AFU, 0x0877U, 0x007EU, 0x05BDU,
	0x09ACU, 0x0CA7U, 0x0BF2U, 0x033EU, 0x006BU, 0x0774U, 0x0C0AU, 0x094AU, 0x0B73U, 0x03C1U, 0x071DU, 0x0A2CU, 0x01C0U, 0x08D8U, 0x02A5U, 0x0806U,
	0x08B2U, 0x01AEU, 0x022BU, 0x034BU, 0x081EU, 0x0367U, 0x060EU, 0x0069U, 0x01A6U, 0x024BU, 0x00B1U, 0x0C16U, 0x0BDEU, 0x0B35U, 0x0626U, 0x0675U,
	0x0C0BU, 0x030AU, 0x0487U, 0x0C6EU, 0x09F8U, 0x05CBU, 0x0AA7U, 0x045FU, 0x06CBU, 0x0284U, 0x0999U, 0x015DU, 0x01A2U, 0x0149U, 0x0C65U, 0x0CB6U,
	0x0331U, 0x0449U, 0x025BU, 0x0262U, 0x052AU, 0x07FCU, 0x0748U, 0x0180U, 0x0842U, 0x0C79U, 0x04C2U, 0x07CAU, 0x0997U, 0x00DCU, 0x085EU, 0x0686U,
	0x0860U, 0x0707U, 0x0803U, 0x031AU, 0x071BU, 0x09ABU, 0x099BU, 0x01DEU, 0x0C95U, 0x0BCDU, 0x03E4U, 0x03DFU, 0x03BEU, 0x074DU, 0x05F2U, 0x065CU
};

int16_t zetas_inv[128] = 
{
	0x06A5U, 0x070FU, 0x05B4U, 0x0943U, 0x0922U, 0x091DU, 0x0134U, 0x006CU, 0x0B23U, 0x0366U, 0x0356U, 0x05E6U, 0x09E7U, 0x04FEU, 0x05FAU, 0x04A1U,
	0x067BU, 0x04A3U, 0x0C25U, 0x036AU, 0x0537U, 0x083FU, 0x0088U, 0x04BFU, 0x0B81U, 0x05B9U, 0x0505U, 0x07D7U, 0x0A9FU, 0x0AA6U, 0x08B8U, 0x09D0U,
	0x004BU, 0x009CU, 0x0BB8U, 0x0B5FU, 0x0BA4U, 0x0368U, 0x0A7DU, 0x0636U, 0x08A2U, 0x025AU, 0x0736U, 0x0309U, 0x0093U, 0x087AU, 0x09F7U, 0x00F6U,
	0x068CU, 0x06DBU, 0x01CCU, 0x0123U, 0x00EBU, 0x0C50U, 0x0AB6U, 0x0B5BU, 0x0C98U, 0x06F3U, 0x099AU, 0x04E3U, 0x09B6U, 0x0AD6U, 0x0B53U, 0x044FU,
	0x04FBU, 0x0A5CU, 0x0429U, 0x0B41U, 0x02D5U, 0x05E4U, 0x0940U, 0x018EU, 0x03B7U, 0x00F7U, 0x058DU, 0x0C96U, 0x09C3U, 0x010FU, 0x005AU, 0x0355U,
	0x0744U, 0x0C83U, 0x048AU, 0x0652U, 0x029AU, 0x0140U, 0x0008U, 0x0AFDU, 0x0608U, 0x011AU, 0x072EU, 0x050DU, 0x090AU, 0x0228U, 0x0A75U, 0x083AU,
	0x0623U, 0x00CDU, 0x0B66U, 0x0606U, 0x0AA1U, 0x0A25U, 0x0908U, 0x02A9U, 0x0082U, 0x0642U, 0x074FU, 0x033DU, 0x0B82U, 0x0BF9U, 0x052DU, 0x0AC4U,
	0x0745U, 0x05C2U, 0x04B2U, 0x093FU, 0x0C4BU, 0x06D8U, 0x0A93U, 0x00ABU, 0x0C37U, 0x0BE2U, 0x0773U, 0x072CU, 0x05EDU, 0x0167U, 0x02F6U, 0x05A1U
};

static int16_t fqmul(int16_t a, int16_t b) 
{
	return montgomery_reduce((int32_t)a * b);
}

void ntt(uint16_t* r) 
{
	uint32_t j;
	uint32_t k;
	uint32_t len;
	uint32_t start;
	uint16_t t;
	int16_t zeta;

	k = 1;

	for (len = 128; len >= 2; len >>= 1) 
	{
		for (start = 0; start < 256; start = j + len) 
		{
			zeta = zetas[k];
			++k;

			for (j = start; j < start + len; ++j) 
			{
				t = (uint16_t)fqmul(zeta, (int16_t)r[j + len]);
				r[j + len] = r[j] - t;
				r[j] = r[j] + t;
			}
		}
	}
}

void invntt(uint16_t* r) 
{
	uint32_t j;
	uint32_t k;
	uint32_t len;
	uint32_t start;
	uint16_t t;
	int16_t zeta;

	k = 0;

	for (len = 2; len <= 128; len <<= 1) 
	{
		for (start = 0; start < 256; start = j + len) 
		{
			zeta = zetas_inv[k];
			++k;

			for (j = start; j < start + len; ++j) 
			{
				t = r[j];
				r[j] = (uint16_t)barrett_reduce((int16_t)(t + r[j + len]));
				r[j + len] = t - r[j + len];
				r[j + len] = (uint16_t)fqmul(zeta, (int16_t)r[j + len]);
			}
		}
	}

	for (j = 0; j < 256; ++j)
	{
		r[j] = (uint16_t)fqmul((int16_t)r[j], zetas_inv[127]);
	}
}

void basemul(uint16_t r[2], const uint16_t a[2], const uint16_t b[2], int16_t zeta) 
{
	r[0] = (uint16_t)fqmul((int16_t)a[1], (int16_t)b[1]);
	r[0] = (uint16_t)fqmul((int16_t)r[0], zeta);
	r[0] += (uint16_t)fqmul((int16_t)a[0], (int16_t)b[0]);
	r[1] = (uint16_t)fqmul((int16_t)a[0], (int16_t)b[1]);
	r[1] += (uint16_t)fqmul((int16_t)a[1], (int16_t)b[0]);
}
