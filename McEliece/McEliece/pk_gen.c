#include "common.h"
#include "params.h"
#include "util.h"
#include "vec.h"
#include "benes.h"
#include "fft.h"
#include "pk_gen.h"

int32_t pk_gen(uint8_t* pk, const uint8_t* sk) 
{
	uint64_t cond[MCELIECE_CONDBYTES / 8];
	uint64_t eval[64][MCELIECE_GFBITS];
	uint64_t inv[64][MCELIECE_GFBITS];
	uint64_t mat[MCELIECE_GFBITS * MCELIECE_SYST][64];
	uint64_t sk_int[MCELIECE_GFBITS];
	uint64_t tmp[MCELIECE_GFBITS];
	uint64_t mask;
	uint64_t u;
	int32_t c;
	int32_t i;
	int32_t j;
	int32_t k;
	int32_t row;
	int32_t tail;
	uint8_t *pkptr = pk;

	const uint64_t points[64][MCELIECE_GFBITS] = 
	{
		{
			0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL,
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL,
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL,
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL,
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL,
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL,
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL,
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL,
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL,
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL,
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL,
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL,
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL,
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL,
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL,
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL,
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL,
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL,
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL,
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL,
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL,
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL,
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL,
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL,
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL,
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL,
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL,
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL,
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL,
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL,
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL,
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL,
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL,
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL,
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL,
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL,
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL,
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL,
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL,
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL,
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL,
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL,
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL,
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL,
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL,
			0x0000000000000000ULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL,
			0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL,
			0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		},
		{
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL,
			0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFF00000000ULL, 0xFFFF0000FFFF0000ULL,
			0xFF00FF00FF00FF00ULL, 0xF0F0F0F0F0F0F0F0ULL, 0xCCCCCCCCCCCCCCCCULL, 0xAAAAAAAAAAAAAAAAULL,
		}
	};

	/* compute the inverses */

	for (i = 0; i < MCELIECE_GFBITS; i++)
	{
		sk_int[i] = le8to64(sk + i * 8);
	}

	fft(eval, sk_int);
	vec_copy(inv[0], eval[0]);

	for (i = 1; i < 64; i++)
	{
		vec_mul(inv[i], inv[i - 1], eval[i]);
	}

	vec_inv(tmp, inv[63]);

	for (i = 62; i >= 0; i--) 
	{
		vec_mul(inv[i + 1], tmp, inv[i]);
		vec_mul(tmp, tmp, eval[i + 1]);
	}

	vec_copy(inv[0], tmp);

	/* fill matrix */

	for (j = 0; j < 64; j++)
	{
		for (k = 0; k < MCELIECE_GFBITS; k++)
		{
			mat[k][j] = inv[j][k];
		}
	}

	for (i = 1; i < MCELIECE_SYST; i++)
	{
		for (j = 0; j < 64; j++)
		{
			vec_mul(inv[j], inv[j], points[j]);

			for (k = 0; k < MCELIECE_GFBITS; k++)
			{
				mat[i * MCELIECE_GFBITS + k][j] = inv[j][k];
			}
		}
	}

	/* permute */

	for (i = 0; i < MCELIECE_CONDBYTES / 8; i++)
	{
		cond[i] = le8to64(sk + MCELIECE_IRRBYTES + i * 8);
	}

	for (i = 0; i < MCELIECE_GFBITS * MCELIECE_SYST; i++)
	{
		benes_compact(mat[i], cond, 0);
	}

	/* gaussian elimination */

	for (i = 0; i < (MCELIECE_GFBITS * MCELIECE_SYST + 63) / 64; i++)
	{
		for (j = 0; j < 64; j++)
		{
			row = i * 64 + j;

			if (row >= MCELIECE_GFBITS * MCELIECE_SYST)
			{
				break;
			}

			for (k = row + 1; k < MCELIECE_GFBITS * MCELIECE_SYST; k++)
			{
				mask = mat[row][i] ^ mat[k][i];
				mask >>= j;
				mask &= 1;
				mask = ~mask + 1;

				for (c = 0; c < 64; c++)
				{
					mat[row][c] ^= mat[k][c] & mask;
				}
			}

			if (((mat[row][i] >> j) & 1) == 0)
			{
				/* return if not invertible */
				return -1;
			}

			for (k = 0; k < MCELIECE_GFBITS * MCELIECE_SYST; k++)
			{
				if (k != row)
				{
					mask = mat[k][i] >> j;
					mask &= 1;
					mask = ~mask + 1;

					for (c = 0; c < 64; c++)
					{
						mat[k][c] ^= mat[row][c] & mask;
					}
				}
			}
		}
	}

	/* store pk */
	tail = ((MCELIECE_GFBITS * MCELIECE_SYST) & 63) >> 3;

	for (i = 0; i < MCELIECE_GFBITS * MCELIECE_SYST; i++) 
	{
		u = mat[i][(MCELIECE_GFBITS * MCELIECE_SYST + 63) / 64 - 1];

		for (k = tail; k < 8; k++)
		{
			pkptr[k - tail] = (u >> (8 * k)) & 0xFF;
		}

		pkptr += 8 - tail;

		for (j = (MCELIECE_GFBITS * MCELIECE_SYST + 63) / 64; j < 64; j++) 
		{
			le64to8(pkptr, mat[i][j]);
			pkptr += 8;
		}
	}

	return 0;
}
